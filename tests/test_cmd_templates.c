#include "data/big_buffers.h"
#include "t_cmd_common.h"
#include "t.h"

#include "data/sample_squashfs.h"
#include "data/sample_jpeg.h"
#include "data/sample_png.h"
#include "data/sample_zip.h"

#ifndef TEST
#define TEST(name) test_##name
#endif

int TEST(template_elf)(void)
{
    // clang-format off
    const char* expected =
        "b+00000000         header: \n"
        "b+00000000            e_ident: \n"
        "b+00000000                 ei_mag: 7f454c46\n"
        "b+00000004               ei_class: ELFCLASS32\n"
        "b+00000005                ei_data: ELFDATA2LSB\n"
        "b+00000006             ei_version: 01\n"
        "b+00000007               ei_osabi: ELFOSABI_NONE\n"
        "b+00000008          ei_abiversion: 00\n"
        "b+00000009                 ei_pad: 000000000000\n"
        "b+0000000f              ei_nident: 00\n"
        "b+00000010             e_type: ET_EXEC\n"
        "b+00000012          e_machine: EM_386\n"
        "b+00000014          e_version: 00000001\n"
        "b+00000018            e_entry: 08048074\n"
        "b+0000001c            e_phoff: 00000034\n"
        "b+00000020            e_shoff: 000000a4\n"
        "b+00000024            e_flags: 00000000\n"
        "b+00000028           e_ehsize: 0034\n"
        "b+0000002a        e_phentsize: 0020\n"
        "b+0000002c            e_phnum: 0002\n"
        "b+0000002e        e_shentsize: 0028\n"
        "b+00000030            e_shnum: 0004\n"
        "b+00000032         e_shstrndx: 0003\n"
        "b+00000034           phdr: \n"
        "b+00000034             p_type: PT_LOAD\n"
        "b+00000038           p_offset: 00000000\n"
        "b+0000003c            p_vaddr: 08048000\n"
        "b+00000040            p_paddr: 08048000\n"
        "b+00000044           p_filesz: 00000080\n"
        "b+00000048            p_memsz: 00000080\n"
        "b+0000004c            p_flags: PF_X | PF_R\n"
        "b+00000050            p_align: 00001000\n"
        "b+00000000     PrevPhData: 7f454c46010101000000000000000000...\n"
        "b+00000054           phdr: \n"
        "b+00000054             p_type: PT_LOAD\n"
        "b+00000058           p_offset: 00000080\n"
        "b+0000005c            p_vaddr: 08049080\n"
        "b+00000060            p_paddr: 08049080\n"
        "b+00000064           p_filesz: 0000000c\n"
        "b+00000068            p_memsz: 0000000c\n"
        "b+0000006c            p_flags: PF_W | PF_R\n"
        "b+00000070            p_align: 00001000\n"
        "b+00000080     PrevPhData: 68656c6c6f20776f726c6400\n"
        "b+000000a4           shdr: \n"
        "b+000000a4            sh_name: 00000000\n"
        "b+000000a8            sh_type: SHT_NULL\n"
        "b+000000ac           sh_flags: NONE\n"
        "b+000000b0            sh_addr: 00000000\n"
        "b+000000b4          sh_offset: 00000000\n"
        "b+000000b8            sh_size: 00000000\n"
        "b+000000bc            sh_link: 00000000\n"
        "b+000000c0            sh_info: 00000000\n"
        "b+000000c4       sh_addralign: 00000000\n"
        "b+000000c8         sh_entsize: 00000000\n"
        "b+0000008c     PrevShName: ''\n"
        "b+000000cc           shdr: \n"
        "b+000000cc            sh_name: 0000000b\n"
        "b+000000d0            sh_type: SHT_PROGBITS\n"
        "b+000000d4           sh_flags: SHF_ALLOC | SHF_EXECINSTR\n"
        "b+000000d8            sh_addr: 08048074\n"
        "b+000000dc          sh_offset: 00000074\n"
        "b+000000e0            sh_size: 0000000c\n"
        "b+000000e4            sh_link: 00000000\n"
        "b+000000e8            sh_info: 00000000\n"
        "b+000000ec       sh_addralign: 00000004\n"
        "b+000000f0         sh_entsize: 00000000\n"
        "b+00000097     PrevShName: '.text'\n"
        "b+000000f4           shdr: \n"
        "b+000000f4            sh_name: 00000011\n"
        "b+000000f8            sh_type: SHT_PROGBITS\n"
        "b+000000fc           sh_flags: SHF_WRITE | SHF_ALLOC\n"
        "b+00000100            sh_addr: 08049080\n"
        "b+00000104          sh_offset: 00000080\n"
        "b+00000108            sh_size: 0000000c\n"
        "b+0000010c            sh_link: 00000000\n"
        "b+00000110            sh_info: 00000000\n"
        "b+00000114       sh_addralign: 00000004\n"
        "b+00000118         sh_entsize: 00000000\n"
        "b+0000009d     PrevShName: '.data'\n"
        "b+0000011c           shdr: \n"
        "b+0000011c            sh_name: 00000001\n"
        "b+00000120            sh_type: SHT_STRTAB\n"
        "b+00000124           sh_flags: NONE\n"
        "b+00000128            sh_addr: 00000000\n"
        "b+0000012c          sh_offset: 0000008c\n"
        "b+00000130            sh_size: 00000017\n"
        "b+00000134            sh_link: 00000000\n"
        "b+00000138            sh_info: 00000000\n"
        "b+0000013c       sh_addralign: 00000001\n"
        "b+00000140         sh_entsize: 00000000\n"
        "b+0000008d     PrevShName: '.shstrtab'\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/elf.bhe", elf_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(template_elf_xml)(void)
{
    const char* expected =
        "<root><var name=\"header\" type=\"Elf_Ehdr\" off=\"0\"><var "
        "name=\"e_ident\" type=\"ElfIdent\" off=\"0\"><var name=\"ei_mag\" "
        "type=\"u8[]\" off=\"0\"><buffer>7f454c46</buffer></var><var "
        "name=\"ei_class\" type=\"ElfIdentClass\" off=\"4\"><enum_value "
        "mnemonic=\"ELFCLASS32\">1</enum_value></var><var name=\"ei_data\" "
        "type=\"ElfIdentData\" off=\"5\"><enum_value "
        "mnemonic=\"ELFDATA2LSB\">1</enum_value></var><var name=\"ei_version\" "
        "type=\"u8\" off=\"6\"><unum size=\"1\">1</unum></var><var "
        "name=\"ei_osabi\" type=\"ElfIdentOsABI\" off=\"7\"><enum_value "
        "mnemonic=\"ELFOSABI_NONE\">0</enum_value></var><var "
        "name=\"ei_abiversion\" type=\"u8\" off=\"8\"><unum "
        "size=\"1\">0</unum></var><var name=\"ei_pad\" type=\"u8[]\" "
        "off=\"9\"><buffer>000000000000</buffer></var><var name=\"ei_nident\" "
        "type=\"u8\" off=\"15\"><unum size=\"1\">0</unum></var></var><var "
        "name=\"e_type\" type=\"ElfType\" off=\"16\"><enum_value "
        "mnemonic=\"ET_EXEC\">2</enum_value></var><var name=\"e_machine\" "
        "type=\"ElfMachine\" off=\"18\"><enum_value "
        "mnemonic=\"EM_386\">3</enum_value></var><var name=\"e_version\" "
        "type=\"u32\" off=\"20\"><unum size=\"4\">1</unum></var><var "
        "name=\"e_entry\" type=\"u32\" off=\"24\"><unum "
        "size=\"4\">134512756</unum></var><var name=\"e_phoff\" type=\"u32\" "
        "off=\"28\"><unum size=\"4\">52</unum></var><var name=\"e_shoff\" "
        "type=\"u32\" off=\"32\"><unum size=\"4\">164</unum></var><var "
        "name=\"e_flags\" type=\"u32\" off=\"36\"><unum "
        "size=\"4\">0</unum></var><var name=\"e_ehsize\" type=\"u16\" "
        "off=\"40\"><unum size=\"2\">52</unum></var><var name=\"e_phentsize\" "
        "type=\"u16\" off=\"42\"><unum size=\"2\">32</unum></var><var "
        "name=\"e_phnum\" type=\"u16\" off=\"44\"><unum "
        "size=\"2\">2</unum></var><var name=\"e_shentsize\" type=\"u16\" "
        "off=\"46\"><unum size=\"2\">40</unum></var><var name=\"e_shnum\" "
        "type=\"u16\" off=\"48\"><unum size=\"2\">4</unum></var><var "
        "name=\"e_shstrndx\" type=\"u16\" off=\"50\"><unum "
        "size=\"2\">3</unum></var></var><var name=\"phdr\" type=\"Elf32_Phdr\" "
        "off=\"52\"><var name=\"p_type\" type=\"PhdrType\" "
        "off=\"52\"><enum_value mnemonic=\"PT_LOAD\">1</enum_value></var><var "
        "name=\"p_offset\" type=\"u32\" off=\"56\"><unum "
        "size=\"4\">0</unum></var><var name=\"p_vaddr\" type=\"u32\" "
        "off=\"60\"><unum size=\"4\">134512640</unum></var><var "
        "name=\"p_paddr\" type=\"u32\" off=\"64\"><unum "
        "size=\"4\">134512640</unum></var><var name=\"p_filesz\" type=\"u32\" "
        "off=\"68\"><unum size=\"4\">128</unum></var><var name=\"p_memsz\" "
        "type=\"u32\" off=\"72\"><unum size=\"4\">128</unum></var><var "
        "name=\"p_flags\" type=\"PhdrFlag\" off=\"76\"><enum_value "
        "mnemonic=\"PF_X | PF_R\">5</enum_value></var><var name=\"p_align\" "
        "type=\"u32\" off=\"80\"><unum size=\"4\">4096</unum></var></var><var "
        "name=\"PrevPhData\" type=\"u8[]\" "
        "off=\"0\"><buffer>"
        "7f454c4601010100000000000000000002000300010000007480040834000000a40000"
        "0000000000340020000200280004000300010000000000000000800408008004088000"
        "0000800000000500000000100000010000008000000080900408809004080c0000000c"
        "0000000600000000100000b801000000bb2a000000cd80</buffer></var><var "
        "name=\"phdr\" type=\"Elf32_Phdr\" off=\"84\"><var name=\"p_type\" "
        "type=\"PhdrType\" off=\"84\"><enum_value "
        "mnemonic=\"PT_LOAD\">1</enum_value></var><var name=\"p_offset\" "
        "type=\"u32\" off=\"88\"><unum size=\"4\">128</unum></var><var "
        "name=\"p_vaddr\" type=\"u32\" off=\"92\"><unum "
        "size=\"4\">134516864</unum></var><var name=\"p_paddr\" type=\"u32\" "
        "off=\"96\"><unum size=\"4\">134516864</unum></var><var "
        "name=\"p_filesz\" type=\"u32\" off=\"100\"><unum "
        "size=\"4\">12</unum></var><var name=\"p_memsz\" type=\"u32\" "
        "off=\"104\"><unum size=\"4\">12</unum></var><var name=\"p_flags\" "
        "type=\"PhdrFlag\" off=\"108\"><enum_value mnemonic=\"PF_W | "
        "PF_R\">6</enum_value></var><var name=\"p_align\" type=\"u32\" "
        "off=\"112\"><unum size=\"4\">4096</unum></var></var><var "
        "name=\"PrevPhData\" type=\"u8[]\" "
        "off=\"128\"><buffer>68656c6c6f20776f726c6400</buffer></var><var "
        "name=\"shdr\" type=\"Elf32_Shdr\" off=\"164\"><var name=\"sh_name\" "
        "type=\"u32\" off=\"164\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_type\" type=\"ShdrType\" off=\"168\"><enum_value "
        "mnemonic=\"SHT_NULL\">0</enum_value></var><var name=\"sh_flags\" "
        "type=\"ShrFlag\" off=\"172\"><enum_value "
        "mnemonic=\"NONE\">0</enum_value></var><var name=\"sh_addr\" "
        "type=\"u32\" off=\"176\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_offset\" type=\"u32\" off=\"180\"><unum "
        "size=\"4\">0</unum></var><var name=\"sh_size\" type=\"u32\" "
        "off=\"184\"><unum size=\"4\">0</unum></var><var name=\"sh_link\" "
        "type=\"u32\" off=\"188\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_info\" type=\"u32\" off=\"192\"><unum "
        "size=\"4\">0</unum></var><var name=\"sh_addralign\" type=\"u32\" "
        "off=\"196\"><unum size=\"4\">0</unum></var><var name=\"sh_entsize\" "
        "type=\"u32\" off=\"200\"><unum size=\"4\">0</unum></var></var><var "
        "name=\"PrevShName\" type=\"string\" "
        "off=\"140\"><buffer></buffer></var><var name=\"shdr\" "
        "type=\"Elf32_Shdr\" off=\"204\"><var name=\"sh_name\" type=\"u32\" "
        "off=\"204\"><unum size=\"4\">11</unum></var><var name=\"sh_type\" "
        "type=\"ShdrType\" off=\"208\"><enum_value "
        "mnemonic=\"SHT_PROGBITS\">1</enum_value></var><var name=\"sh_flags\" "
        "type=\"ShrFlag\" off=\"212\"><enum_value mnemonic=\"SHF_ALLOC | "
        "SHF_EXECINSTR\">6</enum_value></var><var name=\"sh_addr\" "
        "type=\"u32\" off=\"216\"><unum size=\"4\">134512756</unum></var><var "
        "name=\"sh_offset\" type=\"u32\" off=\"220\"><unum "
        "size=\"4\">116</unum></var><var name=\"sh_size\" type=\"u32\" "
        "off=\"224\"><unum size=\"4\">12</unum></var><var name=\"sh_link\" "
        "type=\"u32\" off=\"228\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_info\" type=\"u32\" off=\"232\"><unum "
        "size=\"4\">0</unum></var><var name=\"sh_addralign\" type=\"u32\" "
        "off=\"236\"><unum size=\"4\">4</unum></var><var name=\"sh_entsize\" "
        "type=\"u32\" off=\"240\"><unum size=\"4\">0</unum></var></var><var "
        "name=\"PrevShName\" type=\"string\" "
        "off=\"151\"><buffer>2e74657874</buffer></var><var name=\"shdr\" "
        "type=\"Elf32_Shdr\" off=\"244\"><var name=\"sh_name\" type=\"u32\" "
        "off=\"244\"><unum size=\"4\">17</unum></var><var name=\"sh_type\" "
        "type=\"ShdrType\" off=\"248\"><enum_value "
        "mnemonic=\"SHT_PROGBITS\">1</enum_value></var><var name=\"sh_flags\" "
        "type=\"ShrFlag\" off=\"252\"><enum_value mnemonic=\"SHF_WRITE | "
        "SHF_ALLOC\">3</enum_value></var><var name=\"sh_addr\" type=\"u32\" "
        "off=\"256\"><unum size=\"4\">134516864</unum></var><var "
        "name=\"sh_offset\" type=\"u32\" off=\"260\"><unum "
        "size=\"4\">128</unum></var><var name=\"sh_size\" type=\"u32\" "
        "off=\"264\"><unum size=\"4\">12</unum></var><var name=\"sh_link\" "
        "type=\"u32\" off=\"268\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_info\" type=\"u32\" off=\"272\"><unum "
        "size=\"4\">0</unum></var><var name=\"sh_addralign\" type=\"u32\" "
        "off=\"276\"><unum size=\"4\">4</unum></var><var name=\"sh_entsize\" "
        "type=\"u32\" off=\"280\"><unum size=\"4\">0</unum></var></var><var "
        "name=\"PrevShName\" type=\"string\" "
        "off=\"157\"><buffer>2e64617461</buffer></var><var name=\"shdr\" "
        "type=\"Elf32_Shdr\" off=\"284\"><var name=\"sh_name\" type=\"u32\" "
        "off=\"284\"><unum size=\"4\">1</unum></var><var name=\"sh_type\" "
        "type=\"ShdrType\" off=\"288\"><enum_value "
        "mnemonic=\"SHT_STRTAB\">3</enum_value></var><var name=\"sh_flags\" "
        "type=\"ShrFlag\" off=\"292\"><enum_value "
        "mnemonic=\"NONE\">0</enum_value></var><var name=\"sh_addr\" "
        "type=\"u32\" off=\"296\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_offset\" type=\"u32\" off=\"300\"><unum "
        "size=\"4\">140</unum></var><var name=\"sh_size\" type=\"u32\" "
        "off=\"304\"><unum size=\"4\">23</unum></var><var name=\"sh_link\" "
        "type=\"u32\" off=\"308\"><unum size=\"4\">0</unum></var><var "
        "name=\"sh_info\" type=\"u32\" off=\"312\"><unum "
        "size=\"4\">0</unum></var><var name=\"sh_addralign\" type=\"u32\" "
        "off=\"316\"><unum size=\"4\">1</unum></var><var name=\"sh_entsize\" "
        "type=\"u32\" off=\"320\"><unum size=\"4\">0</unum></var></var><var "
        "name=\"PrevShName\" type=\"string\" "
        "off=\"141\"><buffer>2e7368737472746162</buffer></var></root>\n";

    int r = TEST_FAILED;
    if (exec_commands_on("t/x ./templates/elf.bhe", elf_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(template_pe)(void)
{
    // clang-format off
    const char* expected = 
        "b+00000000                    DosHeader: \n"
        "b+00000000                          e_magic: 5a4d\n"
        "b+00000002                           e_cblp: 0000\n"
        "b+00000004                             e_cp: 4550\n"
        "b+00000006                           e_crlc: 0000\n"
        "b+00000008                        e_cparhdr: 8664\n"
        "b+0000000a                       e_minalloc: 0001\n"
        "b+0000000c                       e_maxalloc: 654d\n"
        "b+0000000e                             e_ss: 7373\n"
        "b+00000010                             e_sp: 6761\n"
        "b+00000012                           e_csum: 4265\n"
        "b+00000014                             e_ip: 786f\n"
        "b+00000016                             e_cs: 0057\n"
        "b+00000018                         e_lfarlc: 0080\n"
        "b+0000001a                           e_ovno: 0022\n"
        "b+0000001c                            e_res: [ 020b, 0000, 0102, 0000 ]\n"
        "b+00000024                          e_oemid: 25ff\n"
        "b+00000026                        e_oeminfo: 006a\n"
        "b+00000028                           e_res2: [ 0000, 0000, 00fc, 0000, 000a, 0000, 0000, 4000, 0001, 0000 ]\n"
        "b+0000003c                         e_lfanew: 00000004\n"
        "b+00000004                     NTHeader: \n"
        "b+00000004                        Signature: 00004550\n"
        "b+00000008                       FileHeader: \n"
        "b+00000008                              Machine: AMD64\n"
        "b+0000000a                     NumberOfSections: 0001\n"
        "b+0000000c                        TimeDateStamp: 7373654d\n"
        "b+00000010                 PointerToSymbolTable: 42656761\n"
        "b+00000014                      NumberOfSymbols: 0057786f\n"
        "b+00000018                 SizeOfOptionalHeader: 0080\n"
        "b+0000001a                      Characteristics: EXECUTABLE_IMAGE | LARGE_ADDRESS_AWARE\n"
        "b+0000001c              ImageOptionalHeader: \n"
        "b+0000001c                                Magic: 020b\n"
        "b+0000001e                   MajorLinkerVersion: 00\n"
        "b+0000001f                   MinorLinkerVersion: 00\n"
        "b+00000020                           SizeOfCode: 00000102\n"
        "b+00000024                SizeOfInitializedData: 006a25ff\n"
        "b+00000028              SizeOfUninitializedData: 00000000\n"
        "b+0000002c                  AddressOfEntryPoint: 000000fc\n"
        "b+00000030                           BaseOfCode: 0000000a\n"
        "b+00000034                            ImageBase: 0000000140000000\n"
        "b+0000003c                     SectionAlignment: 00000004\n"
        "b+00000040                        FileAlignment: 00000004\n"
        "b+00000044          MajorOperatingSystemVersion: 8d48\n"
        "b+00000046          MinorOperatingSystemVersion: b852\n"
        "b+00000048                    MajorImageVersion: daeb\n"
        "b+0000004a                    MinorImageVersion: 0000\n"
        "b+0000004c                MajorSubsystemVersion: 0006\n"
        "b+0000004e                MinorSubsystemVersion: 0000\n"
        "b+00000050                    Win32VersionValue: 00000000\n"
        "b+00000054                          SizeOfImage: 0000010c\n"
        "b+00000058                        SizeOfHeaders: 000000c4\n"
        "b+0000005c                             CheckSum: 00000000\n"
        "b+00000060                            Subsystem: WINDOWS_GUI\n"
        "b+00000062                   DllCharacteristics: HIGH_ENTROPY_VA | DYNAMIC_BASE | NX_COMPAT | TERMINAL_SERVER_AWARE\n"
        "b+00000064                   SizeOfStackReserve: 0000000000100000\n"
        "b+0000006c                    SizeOfStackCommit: 0000000000001000\n"
        "b+00000074                    SizeOfHeapReserve: 0000000000100000\n"
        "b+0000007c                     SizeOfHeapCommit: 642e323352455355\n"
        "b+00000084                          LoaderFlags: 00006c6c\n"
        "b+00000088                  NumberOfRvaAndSizes: 00000002\n"
        "b+0000008c                 DataDirArray: \n"
        "b+0000008c                           Export: \n"
        "b+0000008c                       VirtualAddress: 0040b941\n"
        "b+00000090                                 Size: b0eb0024\n"
        "b+00000094                           Import: \n"
        "b+00000094                       VirtualAddress: 000000f4\n"
        "b+00000098                                 Size: 00000018\n"
        "b+0000009c                         Resource: \n"
        "b+0000009c                       VirtualAddress: 8d4c002e\n"
        "b+000000a0                                 Size: e8ebc842\n"
        "b+000000a4                        Exception: \n"
        "b+000000a4                       VirtualAddress: 00000102\n"
        "b+000000a8                                 Size: 00000094\n"
        "b+000000ac                         Security: \n"
        "b+000000ac                       VirtualAddress: 00000102\n"
        "b+000000b0                                 Size: 00000094\n"
        "b+000000b4                       Relocation: \n"
        "b+000000b4                       VirtualAddress: 00420041\n"
        "b+000000b8                                 Size: 00440043\n"
        "b+000000bc                            Debug: \n"
        "b+000000bc                       VirtualAddress: 00460045\n"
        "b+000000c0                                 Size: 00000047\n"
        "b+000000c4                     Architecture: \n"
        "b+000000c4                       VirtualAddress: dcafd83d\n"
        "b+000000c8                                 Size: 00540020\n"
        "b+000000cc                        GlobalPtr: \n"
        "b+000000cc                       VirtualAddress: 006e0069\n"
        "b+000000d0                                 Size: 00500079\n"
        "b+000000d4                              Tls: \n"
        "b+000000d4                       VirtualAddress: 00200045\n"
        "b+000000d8                                 Size: 006e006f\n"
        "b+000000dc                       LoadConfig: \n"
        "b+000000dc                       VirtualAddress: 00570020\n"
        "b+000000e0                                 Size: 006e0069\n"
        "b+000000e4                      BoundImport: \n"
        "b+000000e4                       VirtualAddress: 006f0064\n"
        "b+000000e8                                 Size: 00730077\n"
        "b+000000ec                              Iat: \n"
        "b+000000ec                       VirtualAddress: 00310020\n"
        "b+000000f0                                 Size: 00000030\n"
        "b+000000f4                      DelayImport: \n"
        "b+000000f4                       VirtualAddress: 00000108\n"
        "b+000000f8                                 Size: 00000000\n"
        "b+000000fc                        ClrHeader: \n"
        "b+000000fc                       VirtualAddress: 9eebc931\n"
        "b+00000100                                 Size: 0000007c\n"
        "b+00000104                         Reserved: \n"
        "b+00000104                       VirtualAddress: 00000094\n"
        "b+00000108                                 Size: 0000000a\n"
        "b+0000009c                SectionHeader: \n"
        "b+0000009c                             Name: '.'\n"
        "b+000000a4                             Misc: 00000102\n"
        "b+000000a8                   VirtualAddress: 00000094\n"
        "b+000000ac                    SizeOfRawData: 00000102\n"
        "b+000000b0                 PointerToRawData: 00000094\n"
        "b+000000b4             PointerToRelocations: 00420041\n"
        "b+000000b8             PointerToLinenumbers: 00440043\n"
        "b+000000bc              NumberOfRelocations: 0045\n"
        "b+000000be              NumberOfLinenumbers: 0046\n"
        "b+000000c0                  Characteristics: CNT_INITIALIZED_DATA\n"
        "[!] section size [ 258 ] is greater than remaining size [ 120 ], trimming \n"
        "b+00000094                  SectionData: f4000000180000002e004c8d42c8ebe8...\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/pe.bhe", pe_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(template_zip)(void)
{
    // clang-format off
    const char* expected = 
        "b+00000357      endOfCentralDir: \n"
        "b+00000357                signature: 'PK\\x05\\x06'\n"
        "b+0000035b              disk_number: 0000\n"
        "b+0000035d         central_dir_disk: 0000\n"
        "b+0000035f      central_dir_entries: 0005\n"
        "b+00000361            total_entries: 0005\n"
        "b+00000363         central_dir_size: 000001bd\n"
        "b+00000367       central_dir_offset: 0000019a\n"
        "b+0000036b           comment_length: 0000\n"
        " \n"
        "b+0000019a           dirElement: \n"
        "b+0000019a                signature: 'PK\\x01\\x02'\n"
        "b+0000019e          version_made_by: 031e\n"
        "b+000001a0           version_needed: 000a\n"
        "b+000001a2                    flags: NONE\n"
        "b+000001a4       compression_method: NO_COMPRESSION\n"
        "b+000001a6                 mod_time: a2fa\n"
        "b+000001a8                 mod_date: 5ad9\n"
        "b+000001aa                    crc32: 153b7d68\n"
        "b+000001ae          compressed_size: 00000005\n"
        "b+000001b2        uncompressed_size: 00000005\n"
        "b+000001b6          filename_length: 0008\n"
        "b+000001b8       extra_field_length: 0018\n"
        "b+000001ba           comment_length: 0000\n"
        "b+000001bc              disk_number: 0000\n"
        "b+000001be      internal_attributes: 0001\n"
        "b+000001c0      external_attributes: 81a40000\n"
        "b+000001c4      local_header_offset: 00000000\n"
        "b+000001c8                 filename: 'file.txt'\n"
        "b+000001d0               extraField: \n"
        "b+000001d0                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000001d2                ext_timestamp: \n"
        "b+000001d2                        data_size: 0005\n"
        "b+000001d4                            flags: 03\n"
        "b+000001d5                             time: 685c3eb8\n"
        "b+000001d9               extraField: \n"
        "b+000001d9                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000001db                     unix_new: \n"
        "b+000001db                        data_size: 000b\n"
        "b+000001dd                          version: 01\n"
        "b+000001de                              uid: \n"
        "b+000001de                                 size: 04\n"
        "b+000001df                                value: 000001f5\n"
        "b+000001e3                              gid: \n"
        "b+000001e3                                 size: 04\n"
        "b+000001e4                                value: 00000014\n"
        "b+00000000         localElement: \n"
        "b+00000000                signature: 504b0304\n"
        "b+00000004                  version: 000a\n"
        "b+00000006                    flags: NONE\n"
        "b+00000008              compression: NO_COMPRESSION\n"
        "b+0000000a                 mod_time: a2fa\n"
        "b+0000000c                 mod_date: 5ad9\n"
        "b+0000000e                    crc32: 153b7d68\n"
        "b+00000012          compressed_size: 00000005\n"
        "b+00000016        uncompressed_size: 00000005\n"
        "b+0000001a             filename_len: 0008\n"
        "b+0000001c          extra_field_len: 001c\n"
        "b+0000001e                 filename: 'file.txt'\n"
        "b+00000026               extraField: \n"
        "b+00000026                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000028                ext_timestamp: \n"
        "b+00000028                        data_size: 0009\n"
        "b+0000002a                            flags: 03\n"
        "b+0000002b                             time: 685c3eb8\n"
        "b+0000002f                             time: 685c3eb9\n"
        "b+00000033               extraField: \n"
        "b+00000033                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000035                     unix_new: \n"
        "b+00000035                        data_size: 000b\n"
        "b+00000037                          version: 01\n"
        "b+00000038                              uid: \n"
        "b+00000038                                 size: 04\n"
        "b+00000039                                value: 000001f5\n"
        "b+0000003d                              gid: \n"
        "b+0000003d                                 size: 04\n"
        "b+0000003e                                value: 00000014\n"
        "b+00000042                 data: 6369616f0a\n"
        " \n"
        "b+000001e8           dirElement: \n"
        "b+000001e8                signature: 'PK\\x01\\x02'\n"
        "b+000001ec          version_made_by: 031e\n"
        "b+000001ee           version_needed: 000a\n"
        "b+000001f0                    flags: NONE\n"
        "b+000001f2       compression_method: NO_COMPRESSION\n"
        "b+000001f4                 mod_time: a2f2\n"
        "b+000001f6                 mod_date: 5ad9\n"
        "b+000001f8                    crc32: 00000000\n"
        "b+000001fc          compressed_size: 00000000\n"
        "b+00000200        uncompressed_size: 00000000\n"
        "b+00000204          filename_length: 0007\n"
        "b+00000206       extra_field_length: 0018\n"
        "b+00000208           comment_length: 0000\n"
        "b+0000020a              disk_number: 0000\n"
        "b+0000020c      internal_attributes: 0000\n"
        "b+0000020e      external_attributes: 41ed0010\n"
        "b+00000212      local_header_offset: 00000047\n"
        "b+00000216                 filename: 'folder/'\n"
        "b+0000021d               extraField: \n"
        "b+0000021d                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+0000021f                ext_timestamp: \n"
        "b+0000021f                        data_size: 0005\n"
        "b+00000221                            flags: 03\n"
        "b+00000222                             time: 685c3ea7\n"
        "b+00000226               extraField: \n"
        "b+00000226                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000228                     unix_new: \n"
        "b+00000228                        data_size: 000b\n"
        "b+0000022a                          version: 01\n"
        "b+0000022b                              uid: \n"
        "b+0000022b                                 size: 04\n"
        "b+0000022c                                value: 000001f5\n"
        "b+00000230                              gid: \n"
        "b+00000230                                 size: 04\n"
        "b+00000231                                value: 00000014\n"
        "b+00000047         localElement: \n"
        "b+00000047                signature: 504b0304\n"
        "b+0000004b                  version: 000a\n"
        "b+0000004d                    flags: NONE\n"
        "b+0000004f              compression: NO_COMPRESSION\n"
        "b+00000051                 mod_time: a2f2\n"
        "b+00000053                 mod_date: 5ad9\n"
        "b+00000055                    crc32: 00000000\n"
        "b+00000059          compressed_size: 00000000\n"
        "b+0000005d        uncompressed_size: 00000000\n"
        "b+00000061             filename_len: 0007\n"
        "b+00000063          extra_field_len: 001c\n"
        "b+00000065                 filename: 'folder/'\n"
        "b+0000006c               extraField: \n"
        "b+0000006c                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+0000006e                ext_timestamp: \n"
        "b+0000006e                        data_size: 0009\n"
        "b+00000070                            flags: 03\n"
        "b+00000071                             time: 685c3ea7\n"
        "b+00000075                             time: 685c3ec2\n"
        "b+00000079               extraField: \n"
        "b+00000079                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000007b                     unix_new: \n"
        "b+0000007b                        data_size: 000b\n"
        "b+0000007d                          version: 01\n"
        "b+0000007e                              uid: \n"
        "b+0000007e                                 size: 04\n"
        "b+0000007f                                value: 000001f5\n"
        "b+00000083                              gid: \n"
        "b+00000083                                 size: 04\n"
        "b+00000084                                value: 00000014\n"
        " \n"
        "b+00000235           dirElement: \n"
        "b+00000235                signature: 'PK\\x01\\x02'\n"
        "b+00000239          version_made_by: 031e\n"
        "b+0000023b           version_needed: 000a\n"
        "b+0000023d                    flags: NONE\n"
        "b+0000023f       compression_method: NO_COMPRESSION\n"
        "b+00000241                 mod_time: a2eb\n"
        "b+00000243                 mod_date: 5ad9\n"
        "b+00000245                    crc32: 00000000\n"
        "b+00000249          compressed_size: 00000000\n"
        "b+0000024d        uncompressed_size: 00000000\n"
        "b+00000251          filename_length: 0011\n"
        "b+00000253       extra_field_length: 0018\n"
        "b+00000255           comment_length: 0000\n"
        "b+00000257              disk_number: 0000\n"
        "b+00000259      internal_attributes: 0000\n"
        "b+0000025b      external_attributes: 41ed0010\n"
        "b+0000025f      local_header_offset: 00000088\n"
        "b+00000263                 filename: 'folder/subfolder/'\n"
        "b+00000274               extraField: \n"
        "b+00000274                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000276                ext_timestamp: \n"
        "b+00000276                        data_size: 0005\n"
        "b+00000278                            flags: 03\n"
        "b+00000279                             time: 685c3e9a\n"
        "b+0000027d               extraField: \n"
        "b+0000027d                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000027f                     unix_new: \n"
        "b+0000027f                        data_size: 000b\n"
        "b+00000281                          version: 01\n"
        "b+00000282                              uid: \n"
        "b+00000282                                 size: 04\n"
        "b+00000283                                value: 000001f5\n"
        "b+00000287                              gid: \n"
        "b+00000287                                 size: 04\n"
        "b+00000288                                value: 00000014\n"
        "b+00000088         localElement: \n"
        "b+00000088                signature: 504b0304\n"
        "b+0000008c                  version: 000a\n"
        "b+0000008e                    flags: NONE\n"
        "b+00000090              compression: NO_COMPRESSION\n"
        "b+00000092                 mod_time: a2eb\n"
        "b+00000094                 mod_date: 5ad9\n"
        "b+00000096                    crc32: 00000000\n"
        "b+0000009a          compressed_size: 00000000\n"
        "b+0000009e        uncompressed_size: 00000000\n"
        "b+000000a2             filename_len: 0011\n"
        "b+000000a4          extra_field_len: 001c\n"
        "b+000000a6                 filename: 'folder/subfolder/'\n"
        "b+000000b7               extraField: \n"
        "b+000000b7                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000000b9                ext_timestamp: \n"
        "b+000000b9                        data_size: 0009\n"
        "b+000000bb                            flags: 03\n"
        "b+000000bc                             time: 685c3e9a\n"
        "b+000000c0                             time: 685c3ec2\n"
        "b+000000c4               extraField: \n"
        "b+000000c4                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000000c6                     unix_new: \n"
        "b+000000c6                        data_size: 000b\n"
        "b+000000c8                          version: 01\n"
        "b+000000c9                              uid: \n"
        "b+000000c9                                 size: 04\n"
        "b+000000ca                                value: 000001f5\n"
        "b+000000ce                              gid: \n"
        "b+000000ce                                 size: 04\n"
        "b+000000cf                                value: 00000014\n"
        " \n"
        "b+0000028c           dirElement: \n"
        "b+0000028c                signature: 'PK\\x01\\x02'\n"
        "b+00000290          version_made_by: 031e\n"
        "b+00000292           version_needed: 000a\n"
        "b+00000294                    flags: NONE\n"
        "b+00000296       compression_method: NO_COMPRESSION\n"
        "b+00000298                 mod_time: a2eb\n"
        "b+0000029a                 mod_date: 5ad9\n"
        "b+0000029c                    crc32: 9d23d8ef\n"
        "b+000002a0          compressed_size: 00000008\n"
        "b+000002a4        uncompressed_size: 00000008\n"
        "b+000002a8          filename_length: 0026\n"
        "b+000002aa       extra_field_length: 0018\n"
        "b+000002ac           comment_length: 0000\n"
        "b+000002ae              disk_number: 0000\n"
        "b+000002b0      internal_attributes: 0001\n"
        "b+000002b2      external_attributes: 81a40000\n"
        "b+000002b6      local_header_offset: 000000d3\n"
        "b+000002ba                 filename: 'folder/subfolder/file_in_subfolder.txt'\n"
        "b+000002e0               extraField: \n"
        "b+000002e0                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000002e2                ext_timestamp: \n"
        "b+000002e2                        data_size: 0005\n"
        "b+000002e4                            flags: 03\n"
        "b+000002e5                             time: 685c3e9a\n"
        "b+000002e9               extraField: \n"
        "b+000002e9                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000002eb                     unix_new: \n"
        "b+000002eb                        data_size: 000b\n"
        "b+000002ed                          version: 01\n"
        "b+000002ee                              uid: \n"
        "b+000002ee                                 size: 04\n"
        "b+000002ef                                value: 000001f5\n"
        "b+000002f3                              gid: \n"
        "b+000002f3                                 size: 04\n"
        "b+000002f4                                value: 00000014\n"
        "b+000000d3         localElement: \n"
        "b+000000d3                signature: 504b0304\n"
        "b+000000d7                  version: 000a\n"
        "b+000000d9                    flags: NONE\n"
        "b+000000db              compression: NO_COMPRESSION\n"
        "b+000000dd                 mod_time: a2eb\n"
        "b+000000df                 mod_date: 5ad9\n"
        "b+000000e1                    crc32: 9d23d8ef\n"
        "b+000000e5          compressed_size: 00000008\n"
        "b+000000e9        uncompressed_size: 00000008\n"
        "b+000000ed             filename_len: 0026\n"
        "b+000000ef          extra_field_len: 001c\n"
        "b+000000f1                 filename: 'folder/subfolder/file_in_subfolder.txt'\n"
        "b+00000117               extraField: \n"
        "b+00000117                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000119                ext_timestamp: \n"
        "b+00000119                        data_size: 0009\n"
        "b+0000011b                            flags: 03\n"
        "b+0000011c                             time: 685c3e9a\n"
        "b+00000120                             time: 685c3e9b\n"
        "b+00000124               extraField: \n"
        "b+00000124                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000126                     unix_new: \n"
        "b+00000126                        data_size: 000b\n"
        "b+00000128                          version: 01\n"
        "b+00000129                              uid: \n"
        "b+00000129                                 size: 04\n"
        "b+0000012a                                value: 000001f5\n"
        "b+0000012e                              gid: \n"
        "b+0000012e                                 size: 04\n"
        "b+0000012f                                value: 00000014\n"
        "b+00000133                 data: 636f6e74656e740a\n"
        " \n"
        "b+000002f8           dirElement: \n"
        "b+000002f8                signature: 'PK\\x01\\x02'\n"
        "b+000002fc          version_made_by: 031e\n"
        "b+000002fe           version_needed: 000a\n"
        "b+00000300                    flags: NONE\n"
        "b+00000302       compression_method: NO_COMPRESSION\n"
        "b+00000304                 mod_time: a2f2\n"
        "b+00000306                 mod_date: 5ad9\n"
        "b+00000308                    crc32: ec6267d3\n"
        "b+0000030c          compressed_size: 0000000c\n"
        "b+00000310        uncompressed_size: 0000000c\n"
        "b+00000314          filename_length: 0019\n"
        "b+00000316       extra_field_length: 0018\n"
        "b+00000318           comment_length: 0000\n"
        "b+0000031a              disk_number: 0000\n"
        "b+0000031c      internal_attributes: 0001\n"
        "b+0000031e      external_attributes: 81a40000\n"
        "b+00000322      local_header_offset: 0000013b\n"
        "b+00000326                 filename: 'folder/file_in_folder.txt'\n"
        "b+0000033f               extraField: \n"
        "b+0000033f                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000341                ext_timestamp: \n"
        "b+00000341                        data_size: 0005\n"
        "b+00000343                            flags: 03\n"
        "b+00000344                             time: 685c3ea7\n"
        "b+00000348               extraField: \n"
        "b+00000348                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000034a                     unix_new: \n"
        "b+0000034a                        data_size: 000b\n"
        "b+0000034c                          version: 01\n"
        "b+0000034d                              uid: \n"
        "b+0000034d                                 size: 04\n"
        "b+0000034e                                value: 000001f5\n"
        "b+00000352                              gid: \n"
        "b+00000352                                 size: 04\n"
        "b+00000353                                value: 00000014\n"
        "b+0000013b         localElement: \n"
        "b+0000013b                signature: 504b0304\n"
        "b+0000013f                  version: 000a\n"
        "b+00000141                    flags: NONE\n"
        "b+00000143              compression: NO_COMPRESSION\n"
        "b+00000145                 mod_time: a2f2\n"
        "b+00000147                 mod_date: 5ad9\n"
        "b+00000149                    crc32: ec6267d3\n"
        "b+0000014d          compressed_size: 0000000c\n"
        "b+00000151        uncompressed_size: 0000000c\n"
        "b+00000155             filename_len: 0019\n"
        "b+00000157          extra_field_len: 001c\n"
        "b+00000159                 filename: 'folder/file_in_folder.txt'\n"
        "b+00000172               extraField: \n"
        "b+00000172                    header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000174                ext_timestamp: \n"
        "b+00000174                        data_size: 0009\n"
        "b+00000176                            flags: 03\n"
        "b+00000177                             time: 685c3ea7\n"
        "b+0000017b                             time: 685c3ea8\n"
        "b+0000017f               extraField: \n"
        "b+0000017f                    header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000181                     unix_new: \n"
        "b+00000181                        data_size: 000b\n"
        "b+00000183                          version: 01\n"
        "b+00000184                              uid: \n"
        "b+00000184                                 size: 04\n"
        "b+00000185                                value: 000001f5\n"
        "b+00000189                              gid: \n"
        "b+00000189                                 size: 04\n"
        "b+0000018a                                value: 00000014\n"
        "b+0000018e                 data: 636f6e74656e74203132330a\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(sample_zip, sizeof(sample_zip));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on("t ./templates/zip.bhe", tfb) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}

int TEST(template_squashfs_1)(void)
{
    // clang-format off
    const char* expected =
        "b+00000000         superblock: \n"
        "b+00000000                  magic: 'hsqs'\n"
        "b+00000004            inode_count: 00000009\n"
        "b+00000008               mod_time: 68d43dba\n"
        "b+0000000c             block_size: 00020000\n"
        "b+00000010             frag_count: 00000001\n"
        "b+00000014             compressor: GZIP\n"
        "b+00000016              block_log: 0011\n"
        "b+00000018                  flags: INODE_UNCOMPRESSED | DATA_DEDUPLICATED | NFS_EXPORT_TABLE_EXISTS\n"
        "b+0000001a               id_count: 0002\n"
        "b+0000001c          version_major: 0004\n"
        "b+0000001e          version_minor: 0000\n"
        "b+00000020             root_inode: 00000000000000d9\n"
        "b+00000028             bytes_used: 000000000000026f\n"
        "b+00000030               id_table: 0000000000000267\n"
        "b+00000038            xattr_table: ffffffffffffffff\n"
        "b+00000040            inode_table: 000000000000006a\n"
        "b+00000048              dir_table: 0000000000000165\n"
        "b+00000050             frag_table: 0000000000000203\n"
        "b+00000058           export_table: 0000000000000255\n"
        "b+0000006c            inode_h: \n"
        "b+0000006c                   type: NAMED_PIPE\n"
        "b+0000006e            permissions: 01b4\n"
        "b+00000070                    uid: 0000\n"
        "b+00000072                    gid: 0000\n"
        "b+00000074                  mtime: 68d43ce4\n"
        "b+00000078           inode_number: 00000001\n"
        "b+0000007c          inode_ipc: \n"
        "b+0000007c             link_count: 00000001\n"
        "b+00000080            inode_h: \n"
        "b+00000080                   type: SOCKET\n"
        "b+00000082            permissions: 01fd\n"
        "b+00000084                    uid: 0000\n"
        "b+00000086                    gid: 0000\n"
        "b+00000088                  mtime: 68d43d1e\n"
        "b+0000008c           inode_number: 00000002\n"
        "b+00000090          inode_ipc: \n"
        "b+00000090             link_count: 00000001\n"
        "b+00000094            inode_h: \n"
        "b+00000094                   type: BLOCK_DEV\n"
        "b+00000096            permissions: 01a4\n"
        "b+00000098                    uid: 0001\n"
        "b+0000009a                    gid: 0001\n"
        "b+0000009c                  mtime: 68d43d4a\n"
        "b+000000a0           inode_number: 00000003\n"
        "b+000000a4         inode_spec: \n"
        "b+000000a4             link_count: 00000001\n"
        "b+000000a8                dev_num: 000007c8\n"
        "b+000000ac            inode_h: \n"
        "b+000000ac                   type: CHAR_DEV\n"
        "b+000000ae            permissions: 01a4\n"
        "b+000000b0                    uid: 0001\n"
        "b+000000b2                    gid: 0001\n"
        "b+000000b4                  mtime: 68d43d66\n"
        "b+000000b8           inode_number: 00000004\n"
        "b+000000bc         inode_spec: \n"
        "b+000000bc             link_count: 00000001\n"
        "b+000000c0                dev_num: 00005901\n"
        "b+000000c4            inode_h: \n"
        "b+000000c4                   type: FILE\n"
        "b+000000c6            permissions: 01b4\n"
        "b+000000c8                    uid: 0000\n"
        "b+000000ca                    gid: 0000\n"
        "b+000000cc                  mtime: 68d43d77\n"
        "b+000000d0           inode_number: 00000005\n"
        "b+000000d4         inode_file: \n"
        "b+000000d4           blocks_start: 00000000\n"
        "b+000000d8             frag_index: 00000000\n"
        "b+000000dc           block_offset: 00000000\n"
        "b+000000e0              file_size: 00000005\n"
        "b+000000e4        block_sizes: [  ]\n"
        "b+000000e4            inode_h: \n"
        "b+000000e4                   type: SYMLINK\n"
        "b+000000e6            permissions: 01ff\n"
        "b+000000e8                    uid: 0000\n"
        "b+000000ea                    gid: 0000\n"
        "b+000000ec                  mtime: 68d43daf\n"
        "b+000000f0           inode_number: 00000006\n"
        "b+000000f4      inode_symlink: \n"
        "b+000000f4             link_count: 00000001\n"
        "b+000000f8            target_size: 00000009\n"
        "b+000000fc            target_path: 66696c65312e747874\n"
        "b+00000105            inode_h: \n"
        "b+00000105                   type: FILE\n"
        "b+00000107            permissions: 01b4\n"
        "b+00000109                    uid: 0000\n"
        "b+0000010b                    gid: 0000\n"
        "b+0000010d                  mtime: 68d43cbb\n"
        "b+00000111           inode_number: 00000008\n"
        "b+00000115         inode_file: \n"
        "b+00000115           blocks_start: 00000000\n"
        "b+00000119             frag_index: 00000000\n"
        "b+0000011d           block_offset: 00000005\n"
        "b+00000121              file_size: 00000005\n"
        "b+00000125        block_sizes: [  ]\n"
        "b+00000125            inode_h: \n"
        "b+00000125                   type: DIRECTORY\n"
        "b+00000127            permissions: 01fd\n"
        "b+00000129                    uid: 0000\n"
        "b+0000012b                    gid: 0000\n"
        "b+0000012d                  mtime: 68d43cbb\n"
        "b+00000131           inode_number: 00000007\n"
        "b+00000135          inode_dir: \n"
        "b+00000135            block_index: 00000000\n"
        "b+00000139             link_count: 00000002\n"
        "b+0000013d              file_size: 0020\n"
        "b+0000013f           block_offset: 0000\n"
        "b+00000141           parent_inode: 00000009\n"
        "b+00000167         dir_header: \n"
        "b+00000167                  count: 00000000\n"
        "b+0000016b                  start: 00000000\n"
        "b+0000016f           inode_number: 00000008\n"
        "b+00000173          dir_items: [ \n"
        "               [0]\n"
        "b+00000173                 offset: 0099\n"
        "b+00000175           inode_offset: 0000\n"
        "b+00000177                   type: 0002\n"
        "b+00000179              name_size: 0008\n"
        "b+0000017b                   name: 'file0.txt' ]\n"
        "b+00000184            inode_h: \n"
        "b+00000184                   type: NAMED_PIPE\n"
        "b+00000186            permissions: 0000\n"
        "b+00000188                    uid: 0000\n"
        "b+0000018a                    gid: 0000\n"
        "b+0000018c                  mtime: 00000001\n"
        "b+00000190           inode_number: 00000000\n"
        "b+00000194          inode_ipc: \n"
        "b+00000194             link_count: 00030006\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(sample_squashfs, sizeof(sample_squashfs));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on("t ./templates/squashfs.bhe", tfb) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}

int TEST(template_jpeg_1)(void)
{
    // clang-format off
    const char* expected =
        "b+00000000          chunk: \n"
        "b+00000000                 id: SOI\n"
        "b+00000002     app0_chunk: \n"
        "b+00000002                 id: APP0\n"
        "b+00000004               size: 16\n"
        "b+00000006         identifier: 'JFIF'\n"
        "b+0000000b       JFIF_version: 257\n"
        "b+0000000d      density_units: 1\n"
        "b+0000000e          x_density: 72\n"
        "b+00000010          y_density: 72\n"
        "b+00000012        x_thumbnail: 0\n"
        "b+00000013        y_thumbnail: 0\n"
        "b+00000014          chunk: \n"
        "b+00000014                 id: DQT\n"
        "b+00000016               size: 67\n"
        "b+00000018               data: 0050373c463c32504641465a55505f78...\n"
        "b+00000059          chunk: \n"
        "b+00000059                 id: DQT\n"
        "b+0000005b               size: 67\n"
        "b+0000005d               data: 01555a5a786978eb8282ebffffffffff...\n"
        "b+0000009e          chunk: \n"
        "b+0000009e                 id: SOF0\n"
        "b+000000a0               size: 17\n"
        "b+000000a2               data: 080020002003012200021101031101\n"
        "b+000000b1          chunk: \n"
        "b+000000b1                 id: DHT\n"
        "b+000000b3               size: 23\n"
        "b+000000b5               data: 00000301000000000000000000000000...\n"
        "b+000000ca          chunk: \n"
        "b+000000ca                 id: DHT\n"
        "b+000000cc               size: 37\n"
        "b+000000ce               data: 10010002000503040300000000000000...\n"
        "b+000000f1          chunk: \n"
        "b+000000f1                 id: DHT\n"
        "b+000000f3               size: 22\n"
        "b+000000f5               data: 01010101000000000000000000000000...\n"
        "b+00000109          chunk: \n"
        "b+00000109                 id: DHT\n"
        "b+0000010b               size: 23\n"
        "b+0000010d               data: 11010101010000000000000000000000...\n"
        "b+00000122     sos_header: \n"
        "b+00000122                 id: SOS\n"
        "b+00000124               size: 12\n"
        "b+00000126                 ns: 3\n"
        "b+00000127                 ss: 1\n"
        "b+00000128                 se: 0\n"
        "b+00000129              ah_al: 2\n"
        "b+0000012a       sos_data: 110311003f00d7f6556d8e29a593aa74...\n"
        "b+0000019b          chunk: \n"
        "b+0000019b                 id: EOI\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(not_kitty_jpeg, sizeof(not_kitty_jpeg));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on("t ./templates/jpeg.bhe", tfb) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}

int TEST(template_png_1)(void)
{
    // clang-format off
    const char* expected = 
    "b+00000000           signature: \n"
    "b+00000000                      b0: 89\n"
    "b+00000001                     png: 'PNG'\n"
    "b+00000004                   other: 0d0a1a0a\n"
    "b+00000008                ihdr: \n"
    "b+00000008                  length: 0000000d\n"
    "b+0000000c                    type: 'IHDR'\n"
    "b+00000010                   width: 00000020\n"
    "b+00000014                  height: 00000020\n"
    "b+00000018               bit_depth: 08\n"
    "b+00000019              color_type: 03\n"
    "b+0000001a      compression_method: 00\n"
    "b+0000001b           filter_method: 00\n"
    "b+0000001c        interlace_method: 00\n"
    "b+0000001d                     crc: 44a48ac6\n"
    "b+00000021               chunk: \n"
    "b+00000021                  length: 00000019\n"
    "b+00000025                    type: 'tEXt'\n"
    "b+00000029                    data: 536f6674776172650041646f62652049...\n"
    "b+00000042                     crc: 71c9653c\n"
    "b+00000046                plte: \n"
    "b+00000046                  length: 0000000f\n"
    "b+0000004a                    type: 'PLTE'\n"
    "b+0000004e                 entries: [ \n"
    "                   [0]\n"
    "b+0000004e                           r: 66\n"
    "b+0000004f                           g: cc\n"
    "b+00000050                           b: cc\n"
    "                   [1]\n"
    "b+00000051                           r: ff\n"
    "b+00000052                           g: ff\n"
    "b+00000053                           b: ff\n"
    "                   [2]\n"
    "b+00000054                           r: 00\n"
    "b+00000055                           g: 00\n"
    "b+00000056                           b: 00\n"
    "                   [3]\n"
    "b+00000057                           r: 33\n"
    "b+00000058                           g: 99\n"
    "b+00000059                           b: 66\n"
    "                   [4]\n"
    "b+0000005a                           r: 99\n"
    "b+0000005b                           g: ff\n"
    "b+0000005c                           b: cc ]\n"
    "b+0000005d                     crc: 3e4caf15\n"
    "b+00000061                idat: \n"
    "b+00000061                  length: 00000061\n"
    "b+00000065                    type: 'IDAT'\n"
    "b+00000069         compressed_data: 78dadc93310ec0200c039398ffbfb934...\n"
    "b+000000ca                     crc: b0d7cb9a\n"
    "b+000000ce                iend: \n"
    "b+000000ce                  length: 00000000\n"
    "b+000000d2                    type: 'IEND'\n"
    "b+000000d6                     crc: ae426082\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(not_kitty_png, sizeof(not_kitty_png));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on("t ./templates/png.bhe", tfb) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}

int TEST(template_interactive_1)(void)
{
    // clang-format off
    const char* expected =
        "b+00000000  a: 4e455458\n"
        "b+00000004  b: 4748504a\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(pseudo_random, sizeof(pseudo_random));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on_ex("t/i \"u32 a; u32 b;\"", tfb, 0) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}
