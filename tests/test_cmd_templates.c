#include "t_cmd_common.h"
#include "t.h"

#include "data/sample_zip.h"

#ifndef TEST
#define TEST(name) test_##name
#endif

int TEST(template_elf)(void)
{
    // clang-format off
    const char* expected =
        "\n"
        "b+00000000                header: \n"
        "b+00000000                   e_ident: \n"
        "b+00000000                        ei_mag: 7f454c46\n"
        "b+00000004                      ei_class: ELFCLASS32\n"
        "b+00000005                       ei_data: ELFDATA2LSB\n"
        "b+00000006                    ei_version: 01\n"
        "b+00000007                      ei_osabi: ELFOSABI_NONE\n"
        "b+00000008                 ei_abiversion: 00\n"
        "b+00000009                        ei_pad: 000000000000\n"
        "b+0000000f                     ei_nident: 00\n"
        "b+00000010                    e_type: ET_EXEC\n"
        "b+00000012                 e_machine: EM_386\n"
        "b+00000014                 e_version: 00000001\n"
        "b+00000018                   e_entry: 08048074\n"
        "b+0000001c                   e_phoff: 00000034\n"
        "b+00000020                   e_shoff: 000000a4\n"
        "b+00000024                   e_flags: 00000000\n"
        "b+00000028                  e_ehsize: 0034\n"
        "b+0000002a               e_phentsize: 0020\n"
        "b+0000002c                   e_phnum: 0002\n"
        "b+0000002e               e_shentsize: 0028\n"
        "b+00000030                   e_shnum: 0004\n"
        "b+00000032                e_shstrndx: 0003\n"
        "b+00000034                  phdr: \n"
        "b+00000034                    p_type: PT_LOAD\n"
        "b+00000038                  p_offset: 00000000\n"
        "b+0000003c                   p_vaddr: 08048000\n"
        "b+00000040                   p_paddr: 08048000\n"
        "b+00000044                  p_filesz: 00000080\n"
        "b+00000048                   p_memsz: 00000080\n"
        "b+0000004c                   p_flags: PF_X | PF_R\n"
        "b+00000050                   p_align: 00001000\n"
        "b+00000000            PrevPhData: 7f454c46010101000000000000000000...\n"
        "b+00000054                  phdr: \n"
        "b+00000054                    p_type: PT_LOAD\n"
        "b+00000058                  p_offset: 00000080\n"
        "b+0000005c                   p_vaddr: 08049080\n"
        "b+00000060                   p_paddr: 08049080\n"
        "b+00000064                  p_filesz: 0000000c\n"
        "b+00000068                   p_memsz: 0000000c\n"
        "b+0000006c                   p_flags: PF_W | PF_R\n"
        "b+00000070                   p_align: 00001000\n"
        "b+00000080            PrevPhData: 68656c6c6f20776f726c6400\n"
        "b+000000a4                  shdr: \n"
        "b+000000a4                   sh_name: 00000000\n"
        "b+000000a8                   sh_type: SHT_NULL\n"
        "b+000000ac                  sh_flags: NONE\n"
        "b+000000b0                   sh_addr: 00000000\n"
        "b+000000b4                 sh_offset: 00000000\n"
        "b+000000b8                   sh_size: 00000000\n"
        "b+000000bc                   sh_link: 00000000\n"
        "b+000000c0                   sh_info: 00000000\n"
        "b+000000c4              sh_addralign: 00000000\n"
        "b+000000c8                sh_entsize: 00000000\n"
        "b+0000008c            PrevShName: ''\n"
        "b+000000cc                  shdr: \n"
        "b+000000cc                   sh_name: 0000000b\n"
        "b+000000d0                   sh_type: SHT_PROGBITS\n"
        "b+000000d4                  sh_flags: SHF_ALLOC | SHF_EXECINSTR\n"
        "b+000000d8                   sh_addr: 08048074\n"
        "b+000000dc                 sh_offset: 00000074\n"
        "b+000000e0                   sh_size: 0000000c\n"
        "b+000000e4                   sh_link: 00000000\n"
        "b+000000e8                   sh_info: 00000000\n"
        "b+000000ec              sh_addralign: 00000004\n"
        "b+000000f0                sh_entsize: 00000000\n"
        "b+00000097            PrevShName: '.text'\n"
        "b+000000f4                  shdr: \n"
        "b+000000f4                   sh_name: 00000011\n"
        "b+000000f8                   sh_type: SHT_PROGBITS\n"
        "b+000000fc                  sh_flags: SHF_WRITE | SHF_ALLOC\n"
        "b+00000100                   sh_addr: 08049080\n"
        "b+00000104                 sh_offset: 00000080\n"
        "b+00000108                   sh_size: 0000000c\n"
        "b+0000010c                   sh_link: 00000000\n"
        "b+00000110                   sh_info: 00000000\n"
        "b+00000114              sh_addralign: 00000004\n"
        "b+00000118                sh_entsize: 00000000\n"
        "b+0000009d            PrevShName: '.data'\n"
        "b+0000011c                  shdr: \n"
        "b+0000011c                   sh_name: 00000001\n"
        "b+00000120                   sh_type: SHT_STRTAB\n"
        "b+00000124                  sh_flags: NONE\n"
        "b+00000128                   sh_addr: 00000000\n"
        "b+0000012c                 sh_offset: 0000008c\n"
        "b+00000130                   sh_size: 00000017\n"
        "b+00000134                   sh_link: 00000000\n"
        "b+00000138                   sh_info: 00000000\n"
        "b+0000013c              sh_addralign: 00000001\n"
        "b+00000140                sh_entsize: 00000000\n"
        "b+0000008d            PrevShName: '.shstrtab'\n"
        "\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/elf.bhe", elf_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(template_pe)(void)
{
    // clang-format off
    const char* expected = 
        "\n"
        "b+00000000                     DosHeader: \n"
        "b+00000000                           e_magic: 5a4d\n"
        "b+00000002                            e_cblp: 0000\n"
        "b+00000004                              e_cp: 4550\n"
        "b+00000006                            e_crlc: 0000\n"
        "b+00000008                         e_cparhdr: 8664\n"
        "b+0000000a                        e_minalloc: 0001\n"
        "b+0000000c                        e_maxalloc: 654d\n"
        "b+0000000e                              e_ss: 7373\n"
        "b+00000010                              e_sp: 6761\n"
        "b+00000012                            e_csum: 4265\n"
        "b+00000014                              e_ip: 786f\n"
        "b+00000016                              e_cs: 0057\n"
        "b+00000018                          e_lfarlc: 0080\n"
        "b+0000001a                            e_ovno: 0022\n"
        "b+0000001c                             e_res: [ 020b, 0000, 0102, 0000 ]\n"
        "b+00000024                           e_oemid: 25ff\n"
        "b+00000026                         e_oeminfo: 006a\n"
        "b+00000028                            e_res2: [ 0000, 0000, 00fc, 0000, 000a, 0000, 0000, 4000, 0001, 0000 ]\n"
        "b+0000003c                          e_lfanew: 00000004\n"
        "b+00000004                      NTHeader: \n"
        "b+00000004                         Signature: 00004550\n"
        "b+00000008                        FileHeader: \n"
        "b+00000008                               Machine: AMD64\n"
        "b+0000000a                      NumberOfSections: 0001\n"
        "b+0000000c                         TimeDateStamp: 7373654d\n"
        "b+00000010                  PointerToSymbolTable: 42656761\n"
        "b+00000014                       NumberOfSymbols: 0057786f\n"
        "b+00000018                  SizeOfOptionalHeader: 0080\n"
        "b+0000001a                       Characteristics: EXECUTABLE_IMAGE | LARGE_ADDRESS_AWARE\n"
        "b+0000001c               ImageOptionalHeader: \n"
        "b+0000001c                                 Magic: 020b\n"
        "b+0000001e                    MajorLinkerVersion: 00\n"
        "b+0000001f                    MinorLinkerVersion: 00\n"
        "b+00000020                            SizeOfCode: 00000102\n"
        "b+00000024                 SizeOfInitializedData: 006a25ff\n"
        "b+00000028               SizeOfUninitializedData: 00000000\n"
        "b+0000002c                   AddressOfEntryPoint: 000000fc\n"
        "b+00000030                            BaseOfCode: 0000000a\n"
        "b+00000034                             ImageBase: 0000000140000000\n"
        "b+0000003c                      SectionAlignment: 00000004\n"
        "b+00000040                         FileAlignment: 00000004\n"
        "b+00000044           MajorOperatingSystemVersion: 8d48\n"
        "b+00000046           MinorOperatingSystemVersion: b852\n"
        "b+00000048                     MajorImageVersion: daeb\n"
        "b+0000004a                     MinorImageVersion: 0000\n"
        "b+0000004c                 MajorSubsystemVersion: 0006\n"
        "b+0000004e                 MinorSubsystemVersion: 0000\n"
        "b+00000050                     Win32VersionValue: 00000000\n"
        "b+00000054                           SizeOfImage: 0000010c\n"
        "b+00000058                         SizeOfHeaders: 000000c4\n"
        "b+0000005c                              CheckSum: 00000000\n"
        "b+00000060                             Subsystem: WINDOWS_GUI\n"
        "b+00000062                    DllCharacteristics: HIGH_ENTROPY_VA | DYNAMIC_BASE | NX_COMPAT | TERMINAL_SERVER_AWARE\n"
        "b+00000064                    SizeOfStackReserve: 0000000000100000\n"
        "b+0000006c                     SizeOfStackCommit: 0000000000001000\n"
        "b+00000074                     SizeOfHeapReserve: 0000000000100000\n"
        "b+0000007c                      SizeOfHeapCommit: 642e323352455355\n"
        "b+00000084                           LoaderFlags: 00006c6c\n"
        "b+00000088                   NumberOfRvaAndSizes: 00000002\n"
        "b+0000008c                  DataDirArray: \n"
        "b+0000008c                            Export: \n"
        "b+0000008c                        VirtualAddress: 0040b941\n"
        "b+00000090                                  Size: b0eb0024\n"
        "b+00000094                            Import: \n"
        "b+00000094                        VirtualAddress: 000000f4\n"
        "b+00000098                                  Size: 00000018\n"
        "b+0000009c                          Resource: \n"
        "b+0000009c                        VirtualAddress: 8d4c002e\n"
        "b+000000a0                                  Size: e8ebc842\n"
        "b+000000a4                         Exception: \n"
        "b+000000a4                        VirtualAddress: 00000102\n"
        "b+000000a8                                  Size: 00000094\n"
        "b+000000ac                          Security: \n"
        "b+000000ac                        VirtualAddress: 00000102\n"
        "b+000000b0                                  Size: 00000094\n"
        "b+000000b4                        Relocation: \n"
        "b+000000b4                        VirtualAddress: 00420041\n"
        "b+000000b8                                  Size: 00440043\n"
        "b+000000bc                             Debug: \n"
        "b+000000bc                        VirtualAddress: 00460045\n"
        "b+000000c0                                  Size: 00000047\n"
        "b+000000c4                      Architecture: \n"
        "b+000000c4                        VirtualAddress: dcafd83d\n"
        "b+000000c8                                  Size: 00540020\n"
        "b+000000cc                         GlobalPtr: \n"
        "b+000000cc                        VirtualAddress: 006e0069\n"
        "b+000000d0                                  Size: 00500079\n"
        "b+000000d4                               Tls: \n"
        "b+000000d4                        VirtualAddress: 00200045\n"
        "b+000000d8                                  Size: 006e006f\n"
        "b+000000dc                        LoadConfig: \n"
        "b+000000dc                        VirtualAddress: 00570020\n"
        "b+000000e0                                  Size: 006e0069\n"
        "b+000000e4                       BoundImport: \n"
        "b+000000e4                        VirtualAddress: 006f0064\n"
        "b+000000e8                                  Size: 00730077\n"
        "b+000000ec                               Iat: \n"
        "b+000000ec                        VirtualAddress: 00310020\n"
        "b+000000f0                                  Size: 00000030\n"
        "b+000000f4                       DelayImport: \n"
        "b+000000f4                        VirtualAddress: 00000108\n"
        "b+000000f8                                  Size: 00000000\n"
        "b+000000fc                         ClrHeader: \n"
        "b+000000fc                        VirtualAddress: 9eebc931\n"
        "b+00000100                                  Size: 0000007c\n"
        "b+00000104                          Reserved: \n"
        "b+00000104                        VirtualAddress: 00000094\n"
        "b+00000108                                  Size: 0000000a\n"
        "b+0000009c                 SectionHeader: \n"
        "b+0000009c                              Name: '.'\n"
        "b+000000a4                              Misc: 00000102\n"
        "b+000000a8                    VirtualAddress: 00000094\n"
        "b+000000ac                     SizeOfRawData: 00000102\n"
        "b+000000b0                  PointerToRawData: 00000094\n"
        "b+000000b4              PointerToRelocations: 00420041\n"
        "b+000000b8              PointerToLinenumbers: 00440043\n"
        "b+000000bc               NumberOfRelocations: 0045\n"
        "b+000000be               NumberOfLinenumbers: 0046\n"
        "b+000000c0                   Characteristics: CNT_INITIALIZED_DATA\n"
        "[!] section size [ 258 ] is greater than remaining size [ 120 ], trimming \n"
        "b+00000094                   SectionData: f4000000180000002e004c8d42c8ebe8...\n"
        "\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/pe.bhe", pe_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(template_zip)(void)
{
    // clang-format off
    const char* expected = 
        "\n"
        "b+00000357                  endOfCentralDir: \n"
        "b+00000357                            signature: 'PK\\x05\\x06'\n"
        "b+0000035b                          disk_number: 0000\n"
        "b+0000035d                     central_dir_disk: 0000\n"
        "b+0000035f                  central_dir_entries: 0005\n"
        "b+00000361                        total_entries: 0005\n"
        "b+00000363                     central_dir_size: 000001bd\n"
        "b+00000367                   central_dir_offset: 0000019a\n"
        "b+0000036b                       comment_length: 0000\n"
        " \n"
        "b+0000019a                       dirElement: \n"
        "b+0000019a                            signature: 'PK\\x01\\x02'\n"
        "b+0000019e                      version_made_by: 031e\n"
        "b+000001a0                       version_needed: 000a\n"
        "b+000001a2                                flags: NONE\n"
        "b+000001a4                   compression_method: NO_COMPRESSION\n"
        "b+000001a6                             mod_time: a2fa\n"
        "b+000001a8                             mod_date: 5ad9\n"
        "b+000001aa                                crc32: 153b7d68\n"
        "b+000001ae                      compressed_size: 00000005\n"
        "b+000001b2                    uncompressed_size: 00000005\n"
        "b+000001b6                      filename_length: 0008\n"
        "b+000001b8                   extra_field_length: 0018\n"
        "b+000001ba                       comment_length: 0000\n"
        "b+000001bc                          disk_number: 0000\n"
        "b+000001be                  internal_attributes: 0001\n"
        "b+000001c0                  external_attributes: 81a40000\n"
        "b+000001c4                  local_header_offset: 00000000\n"
        "b+000001c8                             filename: 'file.txt'\n"
        "b+000001d0                           extraField: \n"
        "b+000001d0                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000001d2                            ext_timestamp: \n"
        "b+000001d2                                    data_size: 0005\n"
        "b+000001d4                                        flags: 03\n"
        "b+000001d5                                         time: 685c3eb8\n"
        "b+000001d9                           extraField: \n"
        "b+000001d9                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000001db                                 unix_new: \n"
        "b+000001db                                    data_size: 000b\n"
        "b+000001dd                                      version: 01\n"
        "b+000001de                                          uid: \n"
        "b+000001de                                             size: 04\n"
        "b+000001df                                            value: 000001f5\n"
        "b+000001e3                                          gid: \n"
        "b+000001e3                                             size: 04\n"
        "b+000001e4                                            value: 00000014\n"
        "b+00000000                     localElement: \n"
        "b+00000000                            signature: 504b0304\n"
        "b+00000004                              version: 000a\n"
        "b+00000006                                flags: NONE\n"
        "b+00000008                          compression: NO_COMPRESSION\n"
        "b+0000000a                             mod_time: a2fa\n"
        "b+0000000c                             mod_date: 5ad9\n"
        "b+0000000e                                crc32: 153b7d68\n"
        "b+00000012                      compressed_size: 00000005\n"
        "b+00000016                    uncompressed_size: 00000005\n"
        "b+0000001a                         filename_len: 0008\n"
        "b+0000001c                      extra_field_len: 001c\n"
        "b+0000001e                             filename: 'file.txt'\n"
        "b+00000026                           extraField: \n"
        "b+00000026                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000028                            ext_timestamp: \n"
        "b+00000028                                    data_size: 0009\n"
        "b+0000002a                                        flags: 03\n"
        "b+0000002b                                         time: 685c3eb8\n"
        "b+0000002f                                         time: 685c3eb9\n"
        "b+00000033                           extraField: \n"
        "b+00000033                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000035                                 unix_new: \n"
        "b+00000035                                    data_size: 000b\n"
        "b+00000037                                      version: 01\n"
        "b+00000038                                          uid: \n"
        "b+00000038                                             size: 04\n"
        "b+00000039                                            value: 000001f5\n"
        "b+0000003d                                          gid: \n"
        "b+0000003d                                             size: 04\n"
        "b+0000003e                                            value: 00000014\n"
        "b+00000042                                 data: 6369616f0a\n"
        " \n"
        "b+000001e8                       dirElement: \n"
        "b+000001e8                            signature: 'PK\\x01\\x02'\n"
        "b+000001ec                      version_made_by: 031e\n"
        "b+000001ee                       version_needed: 000a\n"
        "b+000001f0                                flags: NONE\n"
        "b+000001f2                   compression_method: NO_COMPRESSION\n"
        "b+000001f4                             mod_time: a2f2\n"
        "b+000001f6                             mod_date: 5ad9\n"
        "b+000001f8                                crc32: 00000000\n"
        "b+000001fc                      compressed_size: 00000000\n"
        "b+00000200                    uncompressed_size: 00000000\n"
        "b+00000204                      filename_length: 0007\n"
        "b+00000206                   extra_field_length: 0018\n"
        "b+00000208                       comment_length: 0000\n"
        "b+0000020a                          disk_number: 0000\n"
        "b+0000020c                  internal_attributes: 0000\n"
        "b+0000020e                  external_attributes: 41ed0010\n"
        "b+00000212                  local_header_offset: 00000047\n"
        "b+00000216                             filename: 'folder/'\n"
        "b+0000021d                           extraField: \n"
        "b+0000021d                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+0000021f                            ext_timestamp: \n"
        "b+0000021f                                    data_size: 0005\n"
        "b+00000221                                        flags: 03\n"
        "b+00000222                                         time: 685c3ea7\n"
        "b+00000226                           extraField: \n"
        "b+00000226                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000228                                 unix_new: \n"
        "b+00000228                                    data_size: 000b\n"
        "b+0000022a                                      version: 01\n"
        "b+0000022b                                          uid: \n"
        "b+0000022b                                             size: 04\n"
        "b+0000022c                                            value: 000001f5\n"
        "b+00000230                                          gid: \n"
        "b+00000230                                             size: 04\n"
        "b+00000231                                            value: 00000014\n"
        "b+00000047                     localElement: \n"
        "b+00000047                            signature: 504b0304\n"
        "b+0000004b                              version: 000a\n"
        "b+0000004d                                flags: NONE\n"
        "b+0000004f                          compression: NO_COMPRESSION\n"
        "b+00000051                             mod_time: a2f2\n"
        "b+00000053                             mod_date: 5ad9\n"
        "b+00000055                                crc32: 00000000\n"
        "b+00000059                      compressed_size: 00000000\n"
        "b+0000005d                    uncompressed_size: 00000000\n"
        "b+00000061                         filename_len: 0007\n"
        "b+00000063                      extra_field_len: 001c\n"
        "b+00000065                             filename: 'folder/'\n"
        "b+0000006c                           extraField: \n"
        "b+0000006c                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+0000006e                            ext_timestamp: \n"
        "b+0000006e                                    data_size: 0009\n"
        "b+00000070                                        flags: 03\n"
        "b+00000071                                         time: 685c3ea7\n"
        "b+00000075                                         time: 685c3ec2\n"
        "b+00000079                           extraField: \n"
        "b+00000079                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000007b                                 unix_new: \n"
        "b+0000007b                                    data_size: 000b\n"
        "b+0000007d                                      version: 01\n"
        "b+0000007e                                          uid: \n"
        "b+0000007e                                             size: 04\n"
        "b+0000007f                                            value: 000001f5\n"
        "b+00000083                                          gid: \n"
        "b+00000083                                             size: 04\n"
        "b+00000084                                            value: 00000014\n"
        " \n"
        "b+00000235                       dirElement: \n"
        "b+00000235                            signature: 'PK\\x01\\x02'\n"
        "b+00000239                      version_made_by: 031e\n"
        "b+0000023b                       version_needed: 000a\n"
        "b+0000023d                                flags: NONE\n"
        "b+0000023f                   compression_method: NO_COMPRESSION\n"
        "b+00000241                             mod_time: a2eb\n"
        "b+00000243                             mod_date: 5ad9\n"
        "b+00000245                                crc32: 00000000\n"
        "b+00000249                      compressed_size: 00000000\n"
        "b+0000024d                    uncompressed_size: 00000000\n"
        "b+00000251                      filename_length: 0011\n"
        "b+00000253                   extra_field_length: 0018\n"
        "b+00000255                       comment_length: 0000\n"
        "b+00000257                          disk_number: 0000\n"
        "b+00000259                  internal_attributes: 0000\n"
        "b+0000025b                  external_attributes: 41ed0010\n"
        "b+0000025f                  local_header_offset: 00000088\n"
        "b+00000263                             filename: 'folder/subfolder/'\n"
        "b+00000274                           extraField: \n"
        "b+00000274                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000276                            ext_timestamp: \n"
        "b+00000276                                    data_size: 0005\n"
        "b+00000278                                        flags: 03\n"
        "b+00000279                                         time: 685c3e9a\n"
        "b+0000027d                           extraField: \n"
        "b+0000027d                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000027f                                 unix_new: \n"
        "b+0000027f                                    data_size: 000b\n"
        "b+00000281                                      version: 01\n"
        "b+00000282                                          uid: \n"
        "b+00000282                                             size: 04\n"
        "b+00000283                                            value: 000001f5\n"
        "b+00000287                                          gid: \n"
        "b+00000287                                             size: 04\n"
        "b+00000288                                            value: 00000014\n"
        "b+00000088                     localElement: \n"
        "b+00000088                            signature: 504b0304\n"
        "b+0000008c                              version: 000a\n"
        "b+0000008e                                flags: NONE\n"
        "b+00000090                          compression: NO_COMPRESSION\n"
        "b+00000092                             mod_time: a2eb\n"
        "b+00000094                             mod_date: 5ad9\n"
        "b+00000096                                crc32: 00000000\n"
        "b+0000009a                      compressed_size: 00000000\n"
        "b+0000009e                    uncompressed_size: 00000000\n"
        "b+000000a2                         filename_len: 0011\n"
        "b+000000a4                      extra_field_len: 001c\n"
        "b+000000a6                             filename: 'folder/subfolder/'\n"
        "b+000000b7                           extraField: \n"
        "b+000000b7                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000000b9                            ext_timestamp: \n"
        "b+000000b9                                    data_size: 0009\n"
        "b+000000bb                                        flags: 03\n"
        "b+000000bc                                         time: 685c3e9a\n"
        "b+000000c0                                         time: 685c3ec2\n"
        "b+000000c4                           extraField: \n"
        "b+000000c4                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000000c6                                 unix_new: \n"
        "b+000000c6                                    data_size: 000b\n"
        "b+000000c8                                      version: 01\n"
        "b+000000c9                                          uid: \n"
        "b+000000c9                                             size: 04\n"
        "b+000000ca                                            value: 000001f5\n"
        "b+000000ce                                          gid: \n"
        "b+000000ce                                             size: 04\n"
        "b+000000cf                                            value: 00000014\n"
        " \n"
        "b+0000028c                       dirElement: \n"
        "b+0000028c                            signature: 'PK\\x01\\x02'\n"
        "b+00000290                      version_made_by: 031e\n"
        "b+00000292                       version_needed: 000a\n"
        "b+00000294                                flags: NONE\n"
        "b+00000296                   compression_method: NO_COMPRESSION\n"
        "b+00000298                             mod_time: a2eb\n"
        "b+0000029a                             mod_date: 5ad9\n"
        "b+0000029c                                crc32: 9d23d8ef\n"
        "b+000002a0                      compressed_size: 00000008\n"
        "b+000002a4                    uncompressed_size: 00000008\n"
        "b+000002a8                      filename_length: 0026\n"
        "b+000002aa                   extra_field_length: 0018\n"
        "b+000002ac                       comment_length: 0000\n"
        "b+000002ae                          disk_number: 0000\n"
        "b+000002b0                  internal_attributes: 0001\n"
        "b+000002b2                  external_attributes: 81a40000\n"
        "b+000002b6                  local_header_offset: 000000d3\n"
        "b+000002ba                             filename: 'folder/subfolder/file_in_subfolder.txt'\n"
        "b+000002e0                           extraField: \n"
        "b+000002e0                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+000002e2                            ext_timestamp: \n"
        "b+000002e2                                    data_size: 0005\n"
        "b+000002e4                                        flags: 03\n"
        "b+000002e5                                         time: 685c3e9a\n"
        "b+000002e9                           extraField: \n"
        "b+000002e9                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+000002eb                                 unix_new: \n"
        "b+000002eb                                    data_size: 000b\n"
        "b+000002ed                                      version: 01\n"
        "b+000002ee                                          uid: \n"
        "b+000002ee                                             size: 04\n"
        "b+000002ef                                            value: 000001f5\n"
        "b+000002f3                                          gid: \n"
        "b+000002f3                                             size: 04\n"
        "b+000002f4                                            value: 00000014\n"
        "b+000000d3                     localElement: \n"
        "b+000000d3                            signature: 504b0304\n"
        "b+000000d7                              version: 000a\n"
        "b+000000d9                                flags: NONE\n"
        "b+000000db                          compression: NO_COMPRESSION\n"
        "b+000000dd                             mod_time: a2eb\n"
        "b+000000df                             mod_date: 5ad9\n"
        "b+000000e1                                crc32: 9d23d8ef\n"
        "b+000000e5                      compressed_size: 00000008\n"
        "b+000000e9                    uncompressed_size: 00000008\n"
        "b+000000ed                         filename_len: 0026\n"
        "b+000000ef                      extra_field_len: 001c\n"
        "b+000000f1                             filename: 'folder/subfolder/file_in_subfolder.txt'\n"
        "b+00000117                           extraField: \n"
        "b+00000117                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000119                            ext_timestamp: \n"
        "b+00000119                                    data_size: 0009\n"
        "b+0000011b                                        flags: 03\n"
        "b+0000011c                                         time: 685c3e9a\n"
        "b+00000120                                         time: 685c3e9b\n"
        "b+00000124                           extraField: \n"
        "b+00000124                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000126                                 unix_new: \n"
        "b+00000126                                    data_size: 000b\n"
        "b+00000128                                      version: 01\n"
        "b+00000129                                          uid: \n"
        "b+00000129                                             size: 04\n"
        "b+0000012a                                            value: 000001f5\n"
        "b+0000012e                                          gid: \n"
        "b+0000012e                                             size: 04\n"
        "b+0000012f                                            value: 00000014\n"
        "b+00000133                                 data: 636f6e74656e740a\n"
        " \n"
        "b+000002f8                       dirElement: \n"
        "b+000002f8                            signature: 'PK\\x01\\x02'\n"
        "b+000002fc                      version_made_by: 031e\n"
        "b+000002fe                       version_needed: 000a\n"
        "b+00000300                                flags: NONE\n"
        "b+00000302                   compression_method: NO_COMPRESSION\n"
        "b+00000304                             mod_time: a2f2\n"
        "b+00000306                             mod_date: 5ad9\n"
        "b+00000308                                crc32: ec6267d3\n"
        "b+0000030c                      compressed_size: 0000000c\n"
        "b+00000310                    uncompressed_size: 0000000c\n"
        "b+00000314                      filename_length: 0019\n"
        "b+00000316                   extra_field_length: 0018\n"
        "b+00000318                       comment_length: 0000\n"
        "b+0000031a                          disk_number: 0000\n"
        "b+0000031c                  internal_attributes: 0001\n"
        "b+0000031e                  external_attributes: 81a40000\n"
        "b+00000322                  local_header_offset: 0000013b\n"
        "b+00000326                             filename: 'folder/file_in_folder.txt'\n"
        "b+0000033f                           extraField: \n"
        "b+0000033f                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000341                            ext_timestamp: \n"
        "b+00000341                                    data_size: 0005\n"
        "b+00000343                                        flags: 03\n"
        "b+00000344                                         time: 685c3ea7\n"
        "b+00000348                           extraField: \n"
        "b+00000348                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+0000034a                                 unix_new: \n"
        "b+0000034a                                    data_size: 000b\n"
        "b+0000034c                                      version: 01\n"
        "b+0000034d                                          uid: \n"
        "b+0000034d                                             size: 04\n"
        "b+0000034e                                            value: 000001f5\n"
        "b+00000352                                          gid: \n"
        "b+00000352                                             size: 04\n"
        "b+00000353                                            value: 00000014\n"
        "b+0000013b                     localElement: \n"
        "b+0000013b                            signature: 504b0304\n"
        "b+0000013f                              version: 000a\n"
        "b+00000141                                flags: NONE\n"
        "b+00000143                          compression: NO_COMPRESSION\n"
        "b+00000145                             mod_time: a2f2\n"
        "b+00000147                             mod_date: 5ad9\n"
        "b+00000149                                crc32: ec6267d3\n"
        "b+0000014d                      compressed_size: 0000000c\n"
        "b+00000151                    uncompressed_size: 0000000c\n"
        "b+00000155                         filename_len: 0019\n"
        "b+00000157                      extra_field_len: 001c\n"
        "b+00000159                             filename: 'folder/file_in_folder.txt'\n"
        "b+00000172                           extraField: \n"
        "b+00000172                                header_id: EXTRA_FIELD_EXTENDED_TIMESTAMP\n"
        "b+00000174                            ext_timestamp: \n"
        "b+00000174                                    data_size: 0009\n"
        "b+00000176                                        flags: 03\n"
        "b+00000177                                         time: 685c3ea7\n"
        "b+0000017b                                         time: 685c3ea8\n"
        "b+0000017f                           extraField: \n"
        "b+0000017f                                header_id: EXTRA_FIELD_UNIX_NEW\n"
        "b+00000181                                 unix_new: \n"
        "b+00000181                                    data_size: 000b\n"
        "b+00000183                                      version: 01\n"
        "b+00000184                                          uid: \n"
        "b+00000184                                             size: 04\n"
        "b+00000185                                            value: 000001f5\n"
        "b+00000189                                          gid: \n"
        "b+00000189                                             size: 04\n"
        "b+0000018a                                            value: 00000014\n"
        "b+0000018e                                 data: 636f6e74656e74203132330a\n"
        " \n"
        "\n";
    // clang-format on

    int              r = TEST_SUCCEEDED;
    DummyFilebuffer* tfb =
        dummyfilebuffer_create(sample_zip, sizeof(sample_zip));
    ASSERT(tfb != NULL);
    ASSERT(exec_commands_on("t ./templates/zip.bhe", tfb) == 0);

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    dummyfilebuffer_destroy(tfb);
    return r;

fail:
    r = TEST_FAILED;
    goto end;
}
