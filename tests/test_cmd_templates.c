#include "t_cmd_common.h"
#include "t.h"

#ifndef TEST
#define TEST(name) test_##name
#endif

int TEST(template_elf)(void)
{
    // clang-format off
    const char* expected =
        "b+00000000                header: \n"
        "b+00000000                   e_ident: \n"
        "b+00000000                        ei_mag: 7f454c46\n"
        "b+00000004                      ei_class: ELFCLASS32\n"
        "b+00000005                       ei_data: ELFDATA2LSB\n"
        "b+00000006                    ei_version: 01\n"
        "b+00000007                      ei_osabi: ELFOSABI_NONE\n"
        "b+00000008                 ei_abiversion: 00\n"
        "b+00000009                        ei_pad: 000000000000\n"
        "b+0000000f                     ei_nident: 00\n"
        "b+00000010                    e_type: ET_EXEC\n"
        "b+00000012                 e_machine: EM_386\n"
        "b+00000014                 e_version: 00000001\n"
        "b+00000018                   e_entry: 08048074\n"
        "b+0000001c                   e_phoff: 00000034\n"
        "b+00000020                   e_shoff: 000000a4\n"
        "b+00000024                   e_flags: 00000000\n"
        "b+00000028                  e_ehsize: 0034\n"
        "b+0000002a               e_phentsize: 0020\n"
        "b+0000002c                   e_phnum: 0002\n"
        "b+0000002e               e_shentsize: 0028\n"
        "b+00000030                   e_shnum: 0004\n"
        "b+00000032                e_shstrndx: 0003\n"
        "b+00000034                  phdr: \n"
        "b+00000034                    p_type: PT_LOAD\n"
        "b+00000038                  p_offset: 00000000\n"
        "b+0000003c                   p_vaddr: 08048000\n"
        "b+00000040                   p_paddr: 08048000\n"
        "b+00000044                  p_filesz: 00000080\n"
        "b+00000048                   p_memsz: 00000080\n"
        "b+0000004c                   p_flags: PF_X | PF_R\n"
        "b+00000050                   p_align: 00001000\n"
        "b+00000000            PrevPhData: 7f454c46010101000000000000000000...\n"
        "b+00000054                  phdr: \n"
        "b+00000054                    p_type: PT_LOAD\n"
        "b+00000058                  p_offset: 00000080\n"
        "b+0000005c                   p_vaddr: 08049080\n"
        "b+00000060                   p_paddr: 08049080\n"
        "b+00000064                  p_filesz: 0000000c\n"
        "b+00000068                   p_memsz: 0000000c\n"
        "b+0000006c                   p_flags: PF_W | PF_R\n"
        "b+00000070                   p_align: 00001000\n"
        "b+00000080            PrevPhData: 68656c6c6f20776f726c6400\n"
        "b+000000a4                  shdr: \n"
        "b+000000a4                   sh_name: 00000000\n"
        "b+000000a8                   sh_type: SHT_NULL\n"
        "b+000000ac                  sh_flags: NONE\n"
        "b+000000b0                   sh_addr: 00000000\n"
        "b+000000b4                 sh_offset: 00000000\n"
        "b+000000b8                   sh_size: 00000000\n"
        "b+000000bc                   sh_link: 00000000\n"
        "b+000000c0                   sh_info: 00000000\n"
        "b+000000c4              sh_addralign: 00000000\n"
        "b+000000c8                sh_entsize: 00000000\n"
        "b+0000008c            PrevShName: ''\n"
        "b+000000cc                  shdr: \n"
        "b+000000cc                   sh_name: 0000000b\n"
        "b+000000d0                   sh_type: SHT_PROGBITS\n"
        "b+000000d4                  sh_flags: SHF_ALLOC | SHF_EXECINSTR\n"
        "b+000000d8                   sh_addr: 08048074\n"
        "b+000000dc                 sh_offset: 00000074\n"
        "b+000000e0                   sh_size: 0000000c\n"
        "b+000000e4                   sh_link: 00000000\n"
        "b+000000e8                   sh_info: 00000000\n"
        "b+000000ec              sh_addralign: 00000004\n"
        "b+000000f0                sh_entsize: 00000000\n"
        "b+00000097            PrevShName: '.text'\n"
        "b+000000f4                  shdr: \n"
        "b+000000f4                   sh_name: 00000011\n"
        "b+000000f8                   sh_type: SHT_PROGBITS\n"
        "b+000000fc                  sh_flags: SHF_WRITE | SHF_ALLOC\n"
        "b+00000100                   sh_addr: 08049080\n"
        "b+00000104                 sh_offset: 00000080\n"
        "b+00000108                   sh_size: 0000000c\n"
        "b+0000010c                   sh_link: 00000000\n"
        "b+00000110                   sh_info: 00000000\n"
        "b+00000114              sh_addralign: 00000004\n"
        "b+00000118                sh_entsize: 00000000\n"
        "b+0000009d            PrevShName: '.data'\n"
        "b+0000011c                  shdr: \n"
        "b+0000011c                   sh_name: 00000001\n"
        "b+00000120                   sh_type: SHT_STRTAB\n"
        "b+00000124                  sh_flags: NONE\n"
        "b+00000128                   sh_addr: 00000000\n"
        "b+0000012c                 sh_offset: 0000008c\n"
        "b+00000130                   sh_size: 00000017\n"
        "b+00000134                   sh_link: 00000000\n"
        "b+00000138                   sh_info: 00000000\n"
        "b+0000013c              sh_addralign: 00000001\n"
        "b+00000140                sh_entsize: 00000000\n"
        "b+0000008d            PrevShName: '.shstrtab'\n"
        "\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/elf.bhe", elf_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    bhex_free(strbuilder_reset(sb));
    return r;
}

int TEST(template_pe)(void)
{
    // clang-format off
    const char* expected = 
        "b+00000000                     DosHeader: \n"
        "b+00000000                           e_magic: 5a4d\n"
        "b+00000002                            e_cblp: 0000\n"
        "b+00000004                              e_cp: 4550\n"
        "b+00000006                            e_crlc: 0000\n"
        "b+00000008                         e_cparhdr: 8664\n"
        "b+0000000a                        e_minalloc: 0001\n"
        "b+0000000c                        e_maxalloc: 654d\n"
        "b+0000000e                              e_ss: 7373\n"
        "b+00000010                              e_sp: 6761\n"
        "b+00000012                            e_csum: 4265\n"
        "b+00000014                              e_ip: 786f\n"
        "b+00000016                              e_cs: 0057\n"
        "b+00000018                          e_lfarlc: 0080\n"
        "b+0000001a                            e_ovno: 0022\n"
        "b+0000001c                             e_res: [ 020b, 0000, 0102, 0000 ]\n"
        "b+00000024                           e_oemid: 25ff\n"
        "b+00000026                         e_oeminfo: 006a\n"
        "b+00000028                            e_res2: [ 0000, 0000, 00fc, 0000, 000a, 0000, 0000, 4000, 0001, 0000 ]\n"
        "b+0000003c                          e_lfanew: 00000004\n"
        "b+00000004                      NTHeader: \n"
        "b+00000004                         Signature: 00004550\n"
        "b+00000008                        FileHeader: \n"
        "b+00000008                               Machine: AMD64\n"
        "b+0000000a                      NumberOfSections: 0001\n"
        "b+0000000c                         TimeDateStamp: 7373654d\n"
        "b+00000010                  PointerToSymbolTable: 42656761\n"
        "b+00000014                       NumberOfSymbols: 0057786f\n"
        "b+00000018                  SizeOfOptionalHeader: 0080\n"
        "b+0000001a                       Characteristics: EXECUTABLE_IMAGE | LARGE_ADDRESS_AWARE\n"
        "b+0000001c               ImageOptionalHeader: \n"
        "b+0000001c                                 Magic: 020b\n"
        "b+0000001e                    MajorLinkerVersion: 00\n"
        "b+0000001f                    MinorLinkerVersion: 00\n"
        "b+00000020                            SizeOfCode: 00000102\n"
        "b+00000024                 SizeOfInitializedData: 006a25ff\n"
        "b+00000028               SizeOfUninitializedData: 00000000\n"
        "b+0000002c                   AddressOfEntryPoint: 000000fc\n"
        "b+00000030                            BaseOfCode: 0000000a\n"
        "b+00000034                             ImageBase: 0000000140000000\n"
        "b+0000003c                      SectionAlignment: 00000004\n"
        "b+00000040                         FileAlignment: 00000004\n"
        "b+00000044           MajorOperatingSystemVersion: 8d48\n"
        "b+00000046           MinorOperatingSystemVersion: b852\n"
        "b+00000048                     MajorImageVersion: daeb\n"
        "b+0000004a                     MinorImageVersion: 0000\n"
        "b+0000004c                 MajorSubsystemVersion: 0006\n"
        "b+0000004e                 MinorSubsystemVersion: 0000\n"
        "b+00000050                     Win32VersionValue: 00000000\n"
        "b+00000054                           SizeOfImage: 0000010c\n"
        "b+00000058                         SizeOfHeaders: 000000c4\n"
        "b+0000005c                              CheckSum: 00000000\n"
        "b+00000060                             Subsystem: WINDOWS_GUI\n"
        "b+00000062                    DllCharacteristics: HIGH_ENTROPY_VA | DYNAMIC_BASE | NX_COMPAT | TERMINAL_SERVER_AWARE\n"
        "b+00000064                    SizeOfStackReserve: 0000000000100000\n"
        "b+0000006c                     SizeOfStackCommit: 0000000000001000\n"
        "b+00000074                     SizeOfHeapReserve: 0000000000100000\n"
        "b+0000007c                      SizeOfHeapCommit: 642e323352455355\n"
        "b+00000084                           LoaderFlags: 00006c6c\n"
        "b+00000088                   NumberOfRvaAndSizes: 00000002\n"
        "b+0000008c                  DataDirArray: \n"
        "b+0000008c                            Export: \n"
        "b+0000008c                        VirtualAddress: 0040b941\n"
        "b+00000090                                  Size: b0eb0024\n"
        "b+00000094                            Import: \n"
        "b+00000094                        VirtualAddress: 000000f4\n"
        "b+00000098                                  Size: 00000018\n"
        "b+0000009c                          Resource: \n"
        "b+0000009c                        VirtualAddress: 8d4c002e\n"
        "b+000000a0                                  Size: e8ebc842\n"
        "b+000000a4                         Exception: \n"
        "b+000000a4                        VirtualAddress: 00000102\n"
        "b+000000a8                                  Size: 00000094\n"
        "b+000000ac                          Security: \n"
        "b+000000ac                        VirtualAddress: 00000102\n"
        "b+000000b0                                  Size: 00000094\n"
        "b+000000b4                        Relocation: \n"
        "b+000000b4                        VirtualAddress: 00420041\n"
        "b+000000b8                                  Size: 00440043\n"
        "b+000000bc                             Debug: \n"
        "b+000000bc                        VirtualAddress: 00460045\n"
        "b+000000c0                                  Size: 00000047\n"
        "b+000000c4                      Architecture: \n"
        "b+000000c4                        VirtualAddress: dcafd83d\n"
        "b+000000c8                                  Size: 00540020\n"
        "b+000000cc                         GlobalPtr: \n"
        "b+000000cc                        VirtualAddress: 006e0069\n"
        "b+000000d0                                  Size: 00500079\n"
        "b+000000d4                               Tls: \n"
        "b+000000d4                        VirtualAddress: 00200045\n"
        "b+000000d8                                  Size: 006e006f\n"
        "b+000000dc                        LoadConfig: \n"
        "b+000000dc                        VirtualAddress: 00570020\n"
        "b+000000e0                                  Size: 006e0069\n"
        "b+000000e4                       BoundImport: \n"
        "b+000000e4                        VirtualAddress: 006f0064\n"
        "b+000000e8                                  Size: 00730077\n"
        "b+000000ec                               Iat: \n"
        "b+000000ec                        VirtualAddress: 00310020\n"
        "b+000000f0                                  Size: 00000030\n"
        "b+000000f4                       DelayImport: \n"
        "b+000000f4                        VirtualAddress: 00000108\n"
        "b+000000f8                                  Size: 00000000\n"
        "b+000000fc                         ClrHeader: \n"
        "b+000000fc                        VirtualAddress: 9eebc931\n"
        "b+00000100                                  Size: 0000007c\n"
        "b+00000104                          Reserved: \n"
        "b+00000104                        VirtualAddress: 00000094\n"
        "b+00000108                                  Size: 0000000a\n"
        "b+0000009c                 SectionHeader: \n"
        "b+0000009c                              Name: '.'\n"
        "b+000000a4                              Misc: 00000102\n"
        "b+000000a8                    VirtualAddress: 00000094\n"
        "b+000000ac                     SizeOfRawData: 00000102\n"
        "b+000000b0                  PointerToRawData: 00000094\n"
        "b+000000b4              PointerToRelocations: 00420041\n"
        "b+000000b8              PointerToLinenumbers: 00440043\n"
        "b+000000bc               NumberOfRelocations: 0045\n"
        "b+000000be               NumberOfLinenumbers: 0046\n"
        "b+000000c0                   Characteristics: CNT_INITIALIZED_DATA\n"
        "[!] section size [258] is greater than remaining size [120], trimming\n"
        "b+00000094                   SectionData: f4000000180000002e004c8d42c8ebe8...\n"
        "\n";
    // clang-format on

    int r = TEST_FAILED;
    if (exec_commands_on("t ./templates/pe.bhe", pe_fb) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    bhex_free(strbuilder_reset(sb));
    return r;
}
