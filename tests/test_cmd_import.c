#include "t_cmd_common.h"
#include "t.h"

#ifndef TEST
#define TEST(name) test_##name
#endif

static char import_buf[1024];

int TEST(insert_1)(void)
{
    // clang-format off
    const char* expected =
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0010: 02 00 03 00 01 00 00 00 74 80 04 08 34 00 00 00   ........t...4...\n"
        " 0020: A4 00 00 00 00 00 00 00 34 00 20 00 02 00 28 00   ........4. ...(.\n"
        " 0030: 04 00 03 00 01 00 00 00 00 00 00 00 00 80 04 08   ................\n"
        " 0040: 00 80 04 08 80 00 00 00 80 00 00 00 05 00 00 00   ................\n"
        " 0050: 00 10 00 00 01 00 00 00 80 00 00 00 80 90 04 08   ................\n"
        " 0060: 80 90 04 08 0C 00 00 00 0C 00 00 00 06 00 00 00   ................\n"
        " 0070: 00 10 00 00 B8 01 00 00 00 BB 2A 00 00 00 CD 80   ..........*.....\n"
        " 0080: 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 00 2E 73 68   hello world...sh\n"
        " 0090: 73 74 72 74 61 62 00 2E 74 65 78 74 00 2E 64 61   strtab..text..da\n"
        " 00a0: 74 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ta..............\n"
        " 00b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00   ................\n"
        " 00d0: 01 00 00 00 06 00 00 00 74 80 04 08 74 00 00 00   ........t...t...\n"
        " 00e0: 0C 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00   ................\n"
        " 00f0: 00 00 00 00 11 00 00 00 01 00 00 00 03 00 00 00   ................\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0010: 02 00 03 00 01 00 00 00 7F 45 4C 46 01 01 01 00   .........ELF....\n"
        " 0020: 00 00 00 00 00 00 00 00 02 00 03 00 01 00 00 00   ................\n"
        " 0030: 74 80 04 08 34 00 00 00 A4 00 00 00 00 00 00 00   t...4...........\n"
        " 0040: 34 00 20 00 02 00 28 00 04 00 03 00 01 00 00 00   4. ...(.........\n"
        " 0050: 00 00 00 00 00 80 04 08 00 80 04 08 80 00 00 00   ................\n"
        " 0060: 80 00 00 00 05 00 00 00 00 10 00 00 01 00 00 00   ................\n"
        " 0070: 80 00 00 00 80 90 04 08 80 90 04 08 0C 00 00 00   ................\n"
        " 0080: 0C 00 00 00 06 00 00 00 00 10 00 00 B8 01 00 00   ................\n"
        " 0090: 00 BB 2A 00 00 00 CD 80 68 65 6C 6C 6F 20 77 6F   ..*.....hello wo\n"
        " 00a0: 72 6C 64 00 00 2E 73 68 73 74 72 74 61 62 00 2E   rld...shstrtab..\n"
        " 00b0: 74 65 78 74 00 2E 64 61 74 61 00 00 00 00 00 00   text..data......\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00e0: 00 00 00 00 0B 00 00 00 01 00 00 00 06 00 00 00   ................\n"
        " 00f0: 74 80 04 08 74 00 00 00 0C 00 00 00 00 00 00 00   t...t...........\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0010: 02 00 03 00 01 00 00 00 74 80 04 08 34 00 00 00   ........t...4...\n"
        " 0020: A4 00 00 00 00 00 00 00 34 00 20 00 02 00 28 00   ........4. ...(.\n"
        " 0030: 04 00 03 00 01 00 00 00 00 00 00 00 00 80 04 08   ................\n"
        " 0040: 00 80 04 08 80 00 00 00 80 00 00 00 05 00 00 00   ................\n"
        " 0050: 00 10 00 00 01 00 00 00 80 00 00 00 80 90 04 08   ................\n"
        " 0060: 80 90 04 08 0C 00 00 00 0C 00 00 00 06 00 00 00   ................\n"
        " 0070: 00 10 00 00 B8 01 00 00 00 BB 2A 00 00 00 CD 80   ..........*.....\n"
        " 0080: 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 00 2E 73 68   hello world...sh\n"
        " 0090: 73 74 72 74 61 62 00 2E 74 65 78 74 00 2E 64 61   strtab..text..da\n"
        " 00a0: 74 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ta..............\n"
        " 00b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00   ................\n"
        " 00d0: 01 00 00 00 06 00 00 00 74 80 04 08 74 00 00 00   ........t...t...\n"
        " 00e0: 0C 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00   ................\n"
        " 00f0: 00 00 00 00 11 00 00 00 01 00 00 00 03 00 00 00   ................\n"
        "\n";
    // clang-format on

    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1, "s 0; p; im %s; p; u; p",
                 dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(insert_2)(void)
{
    // clang-format off
    const char* expected =
        "7F454C4601010100\n"
        "7F454C467F454C46\n"
        "7F454C4601010100\n";
    // clang-format on

    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1,
                 "s 0; p/r 8; im %s 4; p/r 8; u; p/r 8", dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(insert_3)(void)
{
    // clang-format off
    const char* expected =
        "7F454C4601010100\n"
        "010101007F454C46\n"
        "7F454C4601010100\n";
    // clang-format on

    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1,
                 "s 0; p/r 8; im %s 4 4; p/r 8; u; p/r 8",
                 dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(insert_4)(void)
{
    // clang-format off
    const char* expected =
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0010: 02 00 03 00 01 00 00 00 74 80 04 08 34 00 00 00   ........t...4...\n"
        " 0020: A4 00 00 00 00 00 00 00 34 00 20 00 02 00 28 00   ........4. ...(.\n"
        " 0030: 04 00 03 00 01 00 00 00 00 00 00 00 00 80 04 08   ................\n"
        " 0040: 00 80 04 08 80 00 00 00 80 00 00 00 05 00 00 00   ................\n"
        " 0050: 00 10 00 00 01 00 00 00 80 00 00 00 80 90 04 08   ................\n"
        " 0060: 80 90 04 08 0C 00 00 00 0C 00 00 00 06 00 00 00   ................\n"
        " 0070: 00 10 00 00 B8 01 00 00 00 BB 2A 00 00 00 CD 80   ..........*.....\n"
        " 0080: 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 00 2E 73 68   hello world...sh\n"
        " 0090: 73 74 72 74 61 62 00 2E 74 65 78 74 00 2E 64 61   strtab..text..da\n"
        " 00a0: 74 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ta..............\n"
        " 00b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00   ................\n"
        " 00d0: 01 00 00 00 06 00 00 00 74 80 04 08 74 00 00 00   ........t...t...\n"
        " 00e0: 0C 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00   ................\n"
        " 00f0: 00 00 00 00 11 00 00 00 01 00 00 00 03 00 00 00   ................\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 00 00 00 00 00 00 00 00 02 00 03 00 01 00 00 00   ................\n"
        " 0010: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0020: 02 00 03 00 01 00 00 00 74 80 04 08 34 00 00 00   ........t...4...\n"
        " 0030: A4 00 00 00 00 00 00 00 34 00 20 00 02 00 28 00   ........4. ...(.\n"
        " 0040: 04 00 03 00 01 00 00 00 00 00 00 00 00 80 04 08   ................\n"
        " 0050: 00 80 04 08 80 00 00 00 80 00 00 00 05 00 00 00   ................\n"
        " 0060: 00 10 00 00 01 00 00 00 80 00 00 00 80 90 04 08   ................\n"
        " 0070: 80 90 04 08 0C 00 00 00 0C 00 00 00 06 00 00 00   ................\n"
        " 0080: 00 10 00 00 B8 01 00 00 00 BB 2A 00 00 00 CD 80   ..........*.....\n"
        " 0090: 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 00 2E 73 68   hello world...sh\n"
        " 00a0: 73 74 72 74 61 62 00 2E 74 65 78 74 00 2E 64 61   strtab..text..da\n"
        " 00b0: 74 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ta..............\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00d0: 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00   ................\n"
        " 00e0: 01 00 00 00 06 00 00 00 74 80 04 08 74 00 00 00   ........t...t...\n"
        " 00f0: 0C 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00   ................\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        " 0010: 02 00 03 00 01 00 00 00 74 80 04 08 34 00 00 00   ........t...4...\n"
        " 0020: A4 00 00 00 00 00 00 00 34 00 20 00 02 00 28 00   ........4. ...(.\n"
        " 0030: 04 00 03 00 01 00 00 00 00 00 00 00 00 80 04 08   ................\n"
        " 0040: 00 80 04 08 80 00 00 00 80 00 00 00 05 00 00 00   ................\n"
        " 0050: 00 10 00 00 01 00 00 00 80 00 00 00 80 90 04 08   ................\n"
        " 0060: 80 90 04 08 0C 00 00 00 0C 00 00 00 06 00 00 00   ................\n"
        " 0070: 00 10 00 00 B8 01 00 00 00 BB 2A 00 00 00 CD 80   ..........*.....\n"
        " 0080: 68 65 6C 6C 6F 20 77 6F 72 6C 64 00 00 2E 73 68   hello world...sh\n"
        " 0090: 73 74 72 74 61 62 00 2E 74 65 78 74 00 2E 64 61   strtab..text..da\n"
        " 00a0: 74 61 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ta..............\n"
        " 00b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................\n"
        " 00c0: 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 00   ................\n"
        " 00d0: 01 00 00 00 06 00 00 00 74 80 04 08 74 00 00 00   ........t...t...\n"
        " 00e0: 0C 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00   ................\n"
        " 00f0: 00 00 00 00 11 00 00 00 01 00 00 00 03 00 00 00   ................\n"
        "\n";
    // clang-format on

    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1,
                 "s 0; p; im %s 0 8; p; u; p", dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(overwrite_1)(void)
{
    // clang-format off
    const char* expected =
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 FF   .ELF............\n"
        "\n"
        "\n"
        "       00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n"
        "       -----------------------------------------------\n"
        " 0000: 7F 45 4C 46 01 01 01 00 00 00 00 00 00 00 00 00   .ELF............\n"
        "\n";
    // clang-format on

    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1,
                 "s 0; p 16; im/ovw %s; p 16; u; p 16", dfb_alt_2->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        goto end;

    char* out = strbuilder_reset(sb);
    r         = compare_strings_ignoring_X(expected, out);
    bhex_free(out);

end:
    return r;
}

int TEST(invalid_size_1)(void)
{
    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1, "im/ovw %s 99999",
                 dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        r = TEST_SUCCEEDED;
    bhex_free(strbuilder_reset(sb));
    return r;
}

int TEST(invalid_offset_1)(void)
{
    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1, "im/ovw %s 0 99999",
                 dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        r = TEST_SUCCEEDED;
    bhex_free(strbuilder_reset(sb));
    return r;
}

int TEST(invalid_size_with_offset_1)(void)
{
    memset(import_buf, 0, sizeof(import_buf));
    if (snprintf(import_buf, sizeof(import_buf) - 1, "im/ovw %s 16 16",
                 dfb_alt_1->fname) <= 0)
        panic("snprintf failed");

    int r = TEST_FAILED;
    if (exec_commands(import_buf) != 0)
        r = TEST_SUCCEEDED;
    bhex_free(strbuilder_reset(sb));
    return r;
}
