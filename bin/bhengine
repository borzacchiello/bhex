#!/usr/bin/env bash

usage() {
    cat <<'EOF'
Usage:
  bhengine [-l] [-x] [<file> <template>]

Options:
  -l    List available templates
        Use first argument as filter (if provided)
  -x    Output in XML

Arguments:
  <file>      Input file to render with the template
  <template>  Template name (or path to template file) to use
EOF
    exit 1
}

set -euo pipefail

list=0
xflag=0

while getopts ":lx" opt; do
  case "$opt" in
    l) list=1 ;;
    x) xflag=1 ;;
    \?) echo "Unknown option: -$OPTARG" >&2; usage ;;
  esac
done
shift $((OPTIND - 1))

if (( list )); then
  filter=""
  if [ "$#" -ge 1 ]; then
    filter=$1
  fi
  exec bhex -2c "t/l $filter" /dev/null
fi

if [ "$#" -ne 2 ]; then
  usage
fi

file=$1
template=$2

cmd="t"
if (( xflag )); then
  cmd="t/x"
fi

exec bhex -2c "$cmd $template" "$file"
